{% extends "basement/base.html" %}
{% load static %}
{% load custom_filters %}

{% block header_section %}
<script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
{% endblock %}

{% block content %}
<div class="certificate-page">
    <div class="page-header">
        <h1 class="page-title">
            {% if language == 'ru' %}Green Mile –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}Green Mile –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã{% else %}Green Mile Certificate{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ—Å–∞–¥–∫–∏ –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç–∞—Ä—ã{% else %}Professional tree planting certificates{% endif %}
        </p>
    </div>

    <!-- Step 1: Design Selection -->
    <div class="step-container js-step-container" data-step="1" style="display: block;">
        <div class="step-header">
            <div class="step-number">1</div>
            <h2 class="step-title">
                {% if language == 'ru' %}–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–∏–∑–∞–π–Ω—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑{% else %}Choose certificate design{% endif %}
            </h2>
        </div>
        
        <div class="design-grid">
            <div class="design-card active js-design-card" data-design="professional">
                <div class="design-preview">   
                    <div class="cert-preview cert-professional" 
                        style="background-image: url('{% if certificate_templates.professional.background_image %}{{ certificate_templates.professional.background_image.url }}{% else %}{% static 'img/default-professional.png' %}{% endif %}'); 
                        background-size: cover; background-position: center;"
                    >                  
                        <div class="cert-header">
                            <div class="cert-logo">üå±</div>
                            <div class="cert-title">GREEN MILE</div>
                        </div>
                        <div class="cert-main-title">CERTIFICATE</div>
                        <div class="cert-content">
                            <div class="cert-text">Sample certificate text</div>
                            <div class="cert-signature">Signature</div>
                        </div>
                    </div>
                </div>
                <div class="design-info">
                    <h3>{% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏{% else %}Professional{% endif %}</h3>
                    <p>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤{% elif language == 'kz' %}–†–µ—Å–º–∏ –∂–∞“ì–¥–∞–π–ª–∞—Ä “Ø—à—ñ–Ω ”ô–¥–µ–º—ñ –¥–∏–∑–∞–π–Ω{% else %}Elegant design for official occasions{% endif %}</p>
                </div>
            </div>

            <div class="design-card js-design-card" data-design="modern">
                <div class="design-preview">
                    <div class="cert-preview cert-modern" 
                        style="background-image: url('{% if certificate_templates.modern.background_image %}{{ certificate_templates.modern.background_image.url }}{% else %}{% static 'img/default-modern.png' %}{% endif %}'); 
                        background-size: cover; background-position: center;"
                    >
                        <div class="cert-header-modern">
                            <div class="cert-badge">üèÜ</div>
                            <div class="cert-title-modern">ACHIEVEMENT</div>
                        </div>
                        <div class="cert-main-title-modern">GREEN CERTIFICATE</div>
                        <div class="cert-content-modern">
                            <div class="cert-text-modern">Sample text</div>
                            <div class="cert-signature-modern">Signature</div>
                        </div>
                    </div>
                </div>
                <div class="design-info">
                    <h3>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏{% else %}Modern{% endif %}</h3>
                    <p>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å{% elif language == 'kz' %}“ö–∞–∑—ñ—Ä–≥—ñ –∑–∞–º–∞–Ω“ì—ã –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç—ñ–∫ —Å—Ç–∏–ª—å{% else %}Contemporary minimalist style{% endif %}</p>
                </div>
            </div>

            <div class="design-card js-design-card" data-design="elegant">
                <div class="design-preview">
                    <div class="cert-preview cert-elegant" 
                        style="background-image: url('{% if certificate_templates.elegant.background_image %}{{ certificate_templates.elegant.background_image.url }}{% else %}{% static 'img/default-elegant.png' %}{% endif %}'); 
                        background-size: cover; background-position: center;"
                    >
                        <div class="cert-border-elegant">
                            <div class="cert-header-elegant">GREEN MILE</div>
                            <div class="cert-main-title-elegant">Certificate of Achievement</div>
                            <div class="cert-content-elegant">
                                <div class="cert-text-elegant">Sample certificate</div>
                                <div class="cert-signature-elegant">Signature</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="design-info">
                    <h3>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π{% elif language == 'kz' %}–°”ô–Ω–¥—ñ{% else %}Elegant{% endif %}</h3>
                    <p>{% if language == 'ru' %}–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω —Å –æ—Ä–Ω–∞–º–µ–Ω—Ç–∞–º–∏{% elif language == 'kz' %}–û—é-”©—Ä–Ω–µ–∫—Ç—ñ –∫–ª–∞—Å—Å–∏–∫–∞–ª—ã“õ –¥–∏–∑–∞–π–Ω{% else %}Classic design with ornaments{% endif %}</p>
                </div>
            </div>
        </div>

        <div class="step-actions">
            <button class="btn-primary js-step-next">
                {% if language == 'ru' %}–î–∞–ª–µ–µ{% elif language == 'kz' %}”ò—Ä—ñ “õ–∞—Ä–∞–π{% else %}Next{% endif %}
            </button>
        </div>
    </div>

    <!-- Step 2: Template Selection -->
    <div class="step-container js-step-container" data-step="2" style="display: none;">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-header-content">
                <h2 class="step-title">
                    {% if language == 'ru' %}–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω{% elif language == 'kz' %}“Æ–ª–≥—ñ–Ω—ñ —Ç–∞“£–¥–∞“£—ã–∑{% else %}Choose template{% endif %}
                </h2>
                <p class="step-description">
                    {% if language == 'ru' %}–í—ã–±–µ—Ä–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã“£—ã–∑ “Ø—à—ñ–Ω —Ç–∞–º–∞–¥–∞ –¥–∏–∑–∞–π–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑{% else %}Select the perfect design for your certificate{% endif %}
                </p>
            </div>
        </div>

        <div class="template-grid js-template-grid">
            <!-- Templates will be loaded dynamically -->
            {% with design=selected_design|default:"professional" %}
                {% if design == "professional" %}
                    <div class="template-item" data-template-id="p1">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/p1.png' %}" alt="Professional Template 1">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π 1{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ 1{% else %}Professional 1{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 1 –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 1-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 1 of professional design{% endif %}</p>
                        </div>
                    </div>
                    <div class="template-item" data-template-id="p2">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/p2.png' %}" alt="Professional Template 2">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π 2{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ 2{% else %}Professional 2{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 2 –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 2-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 2 of professional design{% endif %}</p>
                        </div>
                    </div>
                    <div class="template-item" data-template-id="p3">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/p3.png' %}" alt="Professional Template 3">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π 3{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ 3{% else %}Professional 3{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 3 –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 3-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 3 of professional design{% endif %}</p>
                        </div>
                    </div>
                {% elif design == "modern" %}
                    <div class="template-item" data-template-id="m1">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/m1.png' %}" alt="Modern Template 1">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π 1{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏ 1{% else %}Modern 1{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 1 —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 1-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 1 of modern design{% endif %}</p>
                        </div>
                    </div>
                    <div class="template-item" data-template-id="m2">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/m2.png' %}" alt="Modern Template 2">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π 2{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏ 2{% else %}Modern 2{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 2 —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 2-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 2 of modern design{% endif %}</p>
                        </div>
                    </div>
                    <div class="template-item" data-template-id="m3">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/m3.png' %}" alt="Modern Template 3">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π 3{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏ 3{% else %}Modern 3{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 3 —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 3-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 3 of modern design{% endif %}</p>
                        </div>
                    </div>
                {% elif design == "elegant" %}
                    <div class="template-item" data-template-id="e1">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/e1.png' %}" alt="Elegant Template 1">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π 1{% elif language == 'kz' %}–°”ô–Ω–¥—ñ 1{% else %}Elegant 1{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 1 —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–°”ô–Ω–¥—ñ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 1-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 1 of elegant design{% endif %}</p>
                        </div>
                    </div>
                    <div class="template-item" data-template-id="e2">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/e2.png' %}" alt="Elegant Template 2">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π 2{% elif language == 'kz' %}–°”ô–Ω–¥—ñ 2{% else %}Elegant 2{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 2 —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–°”ô–Ω–¥—ñ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 2-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 2 of elegant design{% endif %}</p>
                        </div>
                    </div>
                    <div class="template-item" data-template-id="e3">
                        <div class="template-image-container">
                            <img class="template-preview" src="{% static 'img/e3.png' %}" alt="Elegant Template 3">
                        </div>
                        <div class="template-info">
                            <h4>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π 3{% elif language == 'kz' %}–°”ô–Ω–¥—ñ 3{% else %}Elegant 3{% endif %}</h4>
                            <p>{% if language == 'ru' %}–í–∞—Ä–∏–∞–Ω—Ç 3 —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞{% elif language == 'kz' %}–°”ô–Ω–¥—ñ –¥–∏–∑–∞–π–Ω–Ω—ã“£ 3-–Ω“±—Å“õ–∞—Å—ã{% else %}Variant 3 of elegant design{% endif %}</p>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </div>

        <div class="step-actions">
            <button class="btn-secondary js-step-prev">
                {% if language == 'ru' %}–ù–∞–∑–∞–¥{% elif language == 'kz' %}–ê—Ä—Ç“õ–∞{% else %}Back{% endif %}
            </button>
            <button class="btn-primary js-step-next">
                {% if language == 'ru' %}–î–∞–ª–µ–µ{% elif language == 'kz' %}”ò—Ä—ñ “õ–∞—Ä–∞–π{% else %}Next{% endif %}
            </button>
        </div>
    </div>
    
    <!-- Step 3: Certificate Content -->
    <div class="step-container js-step-container" data-step="3" style="display: none;">
        <div class="step-header">
            <div class="step-number">2</div>
            <h2 class="step-title">
                {% if language == 'ru' %}–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑{% else %}Fill the certificate{% endif %}
            </h2>
        </div>

        <div class="certificate-editor">
            <div class="editor-controls">
                <div class="form-group">
                    <label for="recipient-name">
                        {% if language == 'ru' %}–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == 'kz' %}–ê–ª—É—à—ã–Ω—ã“£ –∞—Ç—ã{% else %}Recipient name{% endif %}
                    </label>
                    <input type="text" id="recipient-name" class="form-control" maxlength="50" 
                           placeholder="{% if language == 'ru' %}–í–≤–µ–¥–∏—Ç–µ –∏–º—è{% elif language == 'kz' %}–ê—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Enter name{% endif %}">
                    <small class="char-counter">0/50</small>
                </div>

                <div class="form-group">
                    <label for="certificate-text">
                        {% if language == 'ru' %}–¢–µ–∫—Å—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –º”ô—Ç—ñ–Ω—ñ{% else %}Certificate text{% endif %}
                    </label>
                    <textarea id="certificate-text" class="form-control" rows="4" maxlength="300"
                              placeholder="{% if language == 'ru' %}–∑–∞ –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞...{% elif language == 'kz' %}“ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–¥–µ–≥—ñ “Ø–ª–µ—Å—ñ “Ø—à—ñ–Ω...{% else %}for contributing to Kazakhstan's forest restoration...{% endif %}"></textarea>
                    <small class="char-counter">0/300</small>
                </div>

                <div class="form-group">
                    <label for="signature-text">
                        {% if language == 'ru' %}–ü–æ–¥–ø–∏—Å—å{% elif language == 'kz' %}“ö–æ–ª—Ç–∞“£–±–∞{% else %}Signature{% endif %}
                    </label>
                    <input type="text" id="signature-text" class="form-control" maxlength="50"
                           value="{% if language == 'ru' %}–° —É–≤–∞–∂–µ–Ω–∏–µ–º, Green Mile{% elif language == 'kz' %}“ö“±—Ä–º–µ—Ç–ø–µ–Ω, Green Mile{% else %}With respect, Green Mile{% endif %}">
                    <small class="char-counter">0/50</small>
                </div>

                <div class="form-group">
                    <label for="tree-count">
                        {% if language == 'ru' %}–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–ê“ì–∞—à —Å–∞–Ω—ã{% else %}Number of trees{% endif %}
                    </label>
                    <input type="number" id="tree-count" class="form-control" min="10" value="10">
                </div>
            </div>

            <div class="certificate-preview">
                <div id="live-certificate" class="certificate-live professional-cert" style="aspect-ratio: 210 / 297; width: 100%; max-width: 420px; background-image: url('{% static 'img/default-professional.png' %}'); background-size: cover; background-position: center;">
                    <div class="cert-background">
                        <div class="cert-border">
                            <div class="cert-header-section">
                                <div class="cert-logo-section">
                                    <div class="logo-icon">üå±</div>
                                    <div class="org-name">GREEN MILE</div>
                                </div>
                                <div class="cert-number">‚Ññ <span id="cert-number">000001</span> / {% now "d.m.Y" %}</div>
                            </div>
                            
                            <div class="cert-main-section">
                                <h1 class="cert-main-title">
                                    {% if language == 'ru' %}–ë–õ–ê–ì–û–î–ê–†–ù–û–°–¢–¨{% elif language == 'kz' %}–ê–õ“í–´–° –•–ê–¢{% else %}CERTIFICATE OF APPRECIATION{% endif %}
                                </h1>
                                
                                <div class="cert-subtitle">
                                    {% if language == 'ru' %}–ó–∞ –≤–∫–ª–∞–¥ –≤ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ{% elif language == 'kz' %}–ñ–∞—Å—ã–ª –±–æ–ª–∞—à–∞“õ“õ–∞ “Ø–ª–µ—Å “õ–æ—Å“õ–∞–Ω—ã “Ø—à—ñ–Ω{% else %}For a Contribution to a Greener Future{% endif %}
                                </div>
                                
                                <div class="recipient-section">
                                    <div class="recipient-label">
                                        {% if language == 'ru' %}–ù–∞–≥—Ä–∞–∂–¥–∞–µ—Ç—Å—è{% elif language == 'kz' %}–ú–∞—Ä–∞–ø–∞—Ç—Ç–∞–ª–∞–¥—ã{% else %}This certificate is proudly presented to{% endif %}
                                    </div>
                                    <div class="recipient-name" id="live-recipient-name">
                                        {% if language == 'ru' %}–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == 'kz' %}–ê–ª—É—à—ã –∞—Ç—ã{% else %}Recipient Name{% endif %}
                                    </div>
                                </div>
                                
                                <div class="achievement-section">
                                    <div class="tree-info">
                                        <span class="tree-count-display" id="live-tree-count">10</span>
                                        <span class="tree-label" id="tree-label">
                                            {% if language == 'ru' %}–¥–µ—Ä–µ–≤–æ{% elif language == 'kz' %}–ê“ì–∞—à—Ç–∞—Ä —Å–∞–Ω—ã{% else %}Number of trees{% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="cert-description" id="live-cert-text">
                                        {% if language == 'ru' %}–±—ã–ª–æ –ø–æ—Å–∞–∂–µ–Ω–æ –≤ –í–∞—à–µ –∏–º—è, –≤–Ω–æ—Å—è –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑–¥–∞–Ω “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–≥–µ “õ–æ—Å“õ–∞–Ω “Ø–ª–µ—Å—ñ“£—ñ–∑ “Ø—à—ñ–Ω.{% else %}has been planted in your name, supporting forest restoration in Kazakhstan.{% endif %}
                                    </div>
                                </div>
                                
                                <div class="signature-section">
                                    <div class="signature-line">
                                        <div class="signature-text" id="live-signature">
                                            {% if language == 'ru' %}–° –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é, –ö–æ–º–∞–Ω–¥–∞ Green Mile{% elif language == 'kz' %}–ê–ª“ì—ã—Å –±—ñ–ª–¥—ñ—Ä–µ –æ—Ç—ã—Ä—ã–ø, Green Mile “±–∂—ã–º—ã{% else %}With Gratitude, The Green Mile Team{% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="cert-footer">
                                    <div class="website">greenmile.kz</div>
                                    <div class="impact-text">
                                        {% if language == 'ru' %}–í–º–µ—Å—Ç–µ –º—ã —Å–æ–∑–¥–∞—ë–º –∑–µ–ª—ë–Ω–æ–µ –±—É–¥—É—â–µ–µ.{% elif language == 'kz' %}–ë—ñ—Ä–≥–µ –±—ñ–∑ –∂–∞—Å—ã–ª –±–æ–ª–∞—à–∞“õ—Ç—ã “õ“±—Ä–∞–º—ã–∑.{% else %}Together, we are growing a greener tomorrow.{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-actions">
            <button class="btn-secondary js-step-prev">
                {% if language == 'ru' %}–ù–∞–∑–∞–¥{% elif language == 'kz' %}–ê—Ä—Ç“õ–∞{% else %}Back{% endif %}
            </button>
            <button class="btn-primary js-step-next">
                {% if language == 'ru' %}–î–∞–ª–µ–µ{% elif language == 'kz' %}”ò—Ä—ñ “õ–∞—Ä–∞–π{% else %}Next{% endif %}
            </button>
        </div>
    </div> 

    <!-- Step 4: Payment -->
    <div class="step-container js-step-container" data-step="4" style="display: none;">
        <div class="step-header">
            <div class="step-number">3</div>
            <h2 class="step-title">
                {% if language == 'ru' %}–û–ø–ª–∞—Ç–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ{% elif language == 'kz' %}–¢”©–ª–µ–º –∂”ô–Ω–µ –±–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ{% else %}Payment and contact details{% endif %}
            </h2>
        </div>

        <form id="payment-form" class="payment-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-name">
                        {% if language == 'ru' %}–í–∞—à–µ –∏–º—è{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑{% else %}Your name{% endif %} *
                    </label>
                    <input type="text" id="customer-name" name="customerName" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="customer-email">
                        {% if language == 'ru' %}Email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∞–ª—É “Ø—à—ñ–Ω email{% else %}Email for certificate delivery{% endif %} *
                    </label>
                    <input type="email" id="customer-email" name="customerEmail" class="form-control" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="customer-phone">
                        {% if language == 'ru' %}–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ){% elif language == 'kz' %}–¢–µ–ª–µ—Ñ–æ–Ω (–º—ñ–Ω–¥–µ—Ç—Ç—ñ –µ–º–µ—Å){% else %}Phone (optional){% endif %}
                    </label>
                    <input type="tel" id="customer-phone" name="customerPhone" class="form-control">
                </div>

                <div class="form-group">
                    <label for="currency">
                        {% if language == 'ru' %}–í–∞–ª—é—Ç–∞{% elif language == 'kz' %}–í–∞–ª—é—Ç–∞{% else %}Currency{% endif %}
                    </label>
                    <select id="currency" name="currency" class="form-control">
                        <option value="KZT">KZT - –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π —Ç–µ–Ω–≥–µ</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="RUB">RUB - Russian Ruble</option>
                    </select>
                </div>
            </div>

            <div class="order-summary">
                <h3>{% if language == 'ru' %}–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ{% elif language == 'kz' %}–¢”©–ª–µ–º–≥–µ –∂–∞–ª–ø—ã{% else %}Total to pay{% endif %}</h3>
                <div class="summary-item">
                    <span>{% if language == 'ru' %}–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤:{% elif language == 'kz' %}–ê“ì–∞—à —Å–∞–Ω—ã:{% else %}Number of trees:{% endif %}</span>
                    <span id="summary-trees">1</span>
                </div>
                <div class="summary-item">
                    <span>{% if language == 'ru' %}–¶–µ–Ω–∞ –∑–∞ –¥–µ—Ä–µ–≤–æ:{% elif language == 'kz' %}–ê“ì–∞—à –±–∞“ì–∞—Å—ã:{% else %}Price per tree:{% endif %}</span>
                    <span>5000 KZT</span>
                </div>
                <div class="summary-item total">
                    <span>{% if language == 'ru' %}–ò—Ç–æ–≥–æ:{% elif language == 'kz' %}–ñ–∞–ª–ø—ã:{% else %}Total:{% endif %}</span>
                    <span id="summary-total">5000 KZT</span>
                </div>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="privacy-consent" required>
                    <span class="checkmark"></span>
                    <span class="checkbox-text">
                        {% if language == 'ru' %}–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–ö{% elif language == 'kz' %}–ú–µ–Ω “ö–† –∑–∞“£–Ω–∞–º–∞—Å—ã–Ω–∞ —Å”ô–π–∫–µ—Å –∂–µ–∫–µ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ ”©“£–¥–µ—É–≥–µ –∫–µ–ª—ñ—Å–µ–º—ñ–Ω{% else %}I agree to personal data processing in accordance with RK legislation{% endif %}
                    </span>
                </label>
            </div>

            <div class="step-actions">
                <button type="button" class="btn-secondary js-step-prev">
                    {% if language == 'ru' %}–ù–∞–∑–∞–¥{% elif language == 'kz' %}–ê—Ä—Ç“õ–∞{% else %}Back{% endif %}
                </button>
                <button type="submit" class="btn-primary btn-pay">
                    <span class="btn-text">{% if language == 'ru' %}–û–ø–ª–∞—Ç–∏—Ç—å{% elif language == 'kz' %}–¢”©–ª–µ—É{% else %}Pay Now{% endif %}</span>
                    <span class="btn-loader" style="display: none;">‚è≥</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Step 5: Success -->
    <div class="step-container js-step-container" data-step="5" style="display: none;">
        <div class="success-screen">
            <div class="success-icon">‚úÖ</div>
            <h2>{% if language == 'ru' %}–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–∫–ª–∞–¥!{% elif language == 'kz' %}“Æ–ª–µ—Å—ñ“£—ñ–∑ “Ø—à—ñ–Ω —Ä–∞—Ö–º–µ—Ç!{% else %}Thank you for your contribution!{% endif %}</h2>
            <p>{% if language == 'ru' %}–í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email.{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ —Ç”©–ª–µ–º—ñ–Ω —Å”ô—Ç—Ç—ñ ”©“£–¥–µ–ª–¥—ñ. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫”©—Ä—Å–µ—Ç—ñ–ª–≥–µ–Ω email-–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ.{% else %}Your payment has been processed successfully. Certificate has been sent to your email.{% endif %}</p>
            
            <div class="download-section">
                <button class="btn-primary js-download-certificate">
                    üì• {% if language == 'ru' %}–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –∂“Ø–∫—Ç–µ–ø –∞–ª—É{% else %}Download Certificate{% endif %}
                </button>
            </div>

            <div class="share-section">
                <h3>{% if language == 'ru' %}–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º!{% elif language == 'kz' %}–ñ–µ—Ç—ñ—Å—Ç—ñ–≥—ñ“£—ñ–∑–±–µ–Ω –±”©–ª—ñ—Å—ñ“£—ñ–∑!{% else %}Share your achievement!{% endif %}</h3>
                <div class="share-buttons">
                    <button class="share-btn" data-platform="telegram">üì± Telegram</button>
                    <button class="share-btn" data-platform="whatsapp">üí¨ WhatsApp</button>
                    <button class="share-btn" data-platform="facebook">üë• Facebook</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f5f9fc 0%, #e8f5e8 100%);
    }

    .certificate-page {
        max-width: 1280px;
        margin: 0 auto;
        padding: 2rem;
        min-height: 100vh;
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a5f3f;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1.1rem;
        color: #6b7280;
        font-weight: 400;
    }

    .step-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2.5rem;
        margin-bottom: 2rem;
        position: relative;
        z-index: 1;
    }

    /* Step 2: Template Selection */
    .step-container[data-step="2"] {
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        overflow: visible;
    }

    .step-container[data-step="2"]::before {
        content: '';
        position: absolute;
        top: -20px;
        left: -20px;
        right: -20px;
        bottom: -20px;
        background: linear-gradient(135deg, rgba(22, 160, 133, 0.05) 0%, transparent 50%);
        z-index: -1;
        border-radius: 20px;
    }

    .step-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .step-number {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #16a085, #2ecc71);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
    }

    .step-header-content {
        flex: 1;
    }

    .step-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        color: #1a3c34;
        margin: 0;
        font-weight: 700;
        letter-spacing: -0.025em;
    }

    .step-description {
        font-size: 1rem;
        color: #4b5e5a;
        margin: 0.5rem 0 0;
        line-height: 1.5;
        max-width: 600px;
    }

    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        padding: 1rem 0;
    }

    .template-item {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 2px solid #e5e7eb;
        aspect-ratio: 210 / 297;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .template-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(22, 160, 133, 0.15);
        border-color: #16a085;
    }

    .template-item.selected {
        border-color: #16a085;
        box-shadow: 0 8px 20px rgba(22, 160, 133, 0.2);
        transform: scale(1.02);
    }

    .template-item.selected::after {
        content: "‚úì";
        position: absolute;
        top: 12px;
        right: 12px;
        width: 24px;
        height: 24px;
        background: #16a085;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .template-preview {
        width: 100%;
        height: 65%;
        object-fit: cover;
        display: block;
        border-bottom: 1px solid #e5e7eb;
    }

    .template-info {
        padding: 0.75rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
    }

    .template-info h4 {
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #1a3c34;
        margin: 0 0 0.25rem 0;
    }

    .template-info p {
        font-size: 0.85rem;
        color: #6b7280;
        margin: 0;
        line-height: 1.4;
    }

    .no-templates {
        text-align: center;
        font-size: 1rem;
        color: #6b7280;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .step-actions {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        position: relative;
        z-index: 1;
    }

    .btn-primary, .btn-secondary {
        padding: 0.875rem 2rem;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 160px;
        text-align: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #16a085, #2ecc71);
        color: white;
        box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(22, 160, 133, 0.4);
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #1a3c34;
        border: 2px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
        border-color: #16a085;
        color: #16a085;
    }

    /* Design Selection */
    .design-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .design-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .design-card:hover {
        border-color: #16a085;
        box-shadow: 0 8px 20px rgba(22, 160, 133, 0.15);
    }

    .design-card.active {
        border-color: #16a085;
        background: #f0fdfa;
        box-shadow: 0 8px 20px rgba(22, 160, 133, 0.2);
    }

    .design-preview {
        margin-bottom: 1rem;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cert-preview {
        width: 250px;
        height: 160px;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        transform: scale(0.8);
    }

    /* Certificate Styles */
    .cert-professional {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #16a085;
        padding: 1rem;
    }

    .cert-modern {
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        color: white;
        padding: 1rem;
    }

    .cert-elegant {
        background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        color: white;
        padding: 1rem;
    }

    .cert-header, .cert-header-modern, .cert-header-elegant {
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .cert-logo, .cert-badge {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }

    .cert-title, .cert-title-modern, .cert-header-elegant {
        font-family: 'Playfair Display', serif;
        font-size: 1rem;
        font-weight: 700;
    }

    .cert-main-title, .cert-main-title-modern, .cert-main-title-elegant {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .cert-content, .cert-content-modern, .cert-content-elegant {
        text-align: center;
        font-size: 0.8rem;
    }

    .cert-text, .cert-text-modern, .cert-text-elegant {
        margin-bottom: 0.5rem;
    }

    .cert-signature, .cert-signature-modern, .cert-signature-elegant {
        font-style: italic;
        font-size: 0.8rem;
    }

    /* Certificate Live Preview */
    .certificate-live {
        margin: 0 auto;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        transform-style: preserve-3d;
        will-change: transform;
    }

    .certificate-live:hover {
        box-shadow: 0 30px 50px rgba(0, 0, 0, 0.2);
    }

    .cert-background {
        padding: 2rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(22, 160, 133, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(22, 160, 133, 0.05) 0%, transparent 50%);
        position: relative;
    }

    .cert-background::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(22,160,133,0.02) 10px, rgba(22,160,133,0.02) 20px);
    }

    .cert-border {
        padding: 1.5rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .cert-border::before {
        content: '';
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        border-radius: 4px;
        opacity: 0.9;
    }

    .cert-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        background: rgba(255,255,255,0.01);
        border-radius: 25px;
        padding: 0.5rem 1rem;
    }

    .cert-logo-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .logo-icon {
        font-size: 1.8rem;
    }

    .org-name {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem;
        font-weight: 700;
        color: #16a085;
    }

    .cert-number {
        font-size: 0.875rem;
        color: #6b7280;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }

    .cert-main-section {
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .cert-main-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        font-weight: 700;
        color: #1a5f3f;
        margin-bottom: 0.5rem;
        letter-spacing: 2px;
    }

    .cert-subtitle {
        font-size: 1rem;
        color: #6b7280;
        margin-bottom: 1.5rem;
        font-style: italic;
    }

    .recipient-section {
        margin-bottom: 1.5rem;
    }

    .recipient-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }

    .recipient-name {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a5f3f;
        border-bottom: 2px solid #16a085;
        padding-bottom: 0.25rem;
        display: inline-block;
        min-width: 200px;
    }

    .achievement-section {
        margin-bottom: 2rem;
    }

    .tree-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        color: #16a085;
        font-weight: 600;
        background: rgba(22,160,133,0.05);
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        box-shadow: 0 2px 10px rgba(22,160,133,0.1);
    }

    .tree-count-display {
        font-size: 2rem;
        font-weight: 700;
    }

    .cert-description {
        font-size: 1rem;
        color: #4b5e5a;
        line-height: 1.5;
        max-width: 400px;
        margin: 0 auto;
        font-style: italic;
        padding: 1rem;
        border-left: 4px solid #16a085;
    }

    .signature-section {
        margin-bottom: 1.5rem;
    }

    .signature-text {
        font-family: 'Playfair Display', serif;
        font-size: 1.1rem;
        color: #16a085;
        font-style: italic;
        border-top: 2px dashed #16a085;
        padding-top: 0.5rem;
        text-align: right;
    }

    .cert-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
        color: #6b7280;
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
        margin-top: 1rem;
        background: rgba(22,160,133,0.03);
    }

    .website {
        font-weight: 600;
        color: #16a085;
    }

    .impact-text {
        max-width: 200px;
        text-align: right;
        font-style: italic;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        background: #fafafa;
    }

    .form-control:focus {
        outline: none;
        border-color: #16a085;
        box-shadow: 0 0 0 3px rgba(22, 160, 133, 0.1);
        background: white;
    }

    .char-counter {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
        text-align: right;
    }

    /* Certificate Editor */
    .certificate-editor {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        align-items: start;
    }

    .certificate-preview {
        position: sticky;
        top: 2rem;
    }

    /* Form Rows */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    /* Order Summary */
    .order-summary {
        background: #f8fffe;
        border: 2px solid #16a085;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem 0;
    }

    .order-summary h3 {
        font-family: 'Playfair Display', serif;
        color: #1a5f3f;
        margin-bottom: 1rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e0f2f1;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-item.total {
        font-weight: 600;
        font-size: 1.2rem;
        color: #16a085;
        border-top: 2px solid #16a085;
        margin-top: 1rem;
        padding-top: 1rem;
    }

    /* Checkbox */
    .checkbox-group {
        margin: 2rem 0;
    }

    .checkbox-label {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #16a085;
        margin: 0;
    }

    /* Success Screen */
    .success-screen {
        text-align: center;
        padding: 2rem;
    }

    .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: bounce 1s ease-in-out;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }

    .success-screen h2 {
        font-family: 'Playfair Display', serif;
        color: #16a085;
        margin-bottom: 1rem;
    }

    .success-screen p {
        color: #6b7280;
        margin-bottom: 2rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    .download-section {
        margin-bottom: 2rem;
    }

    .share-section h3 {
        color: #1a5f3f;
        margin-bottom: 1rem;
    }

    .share-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .share-btn {
        padding: 0.75rem 1.5rem;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .share-btn:hover {
        border-color: #16a085;
        background: #f0fdfa;
    }

    @keyframes checkmarkAppear {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 900px) {
        .certificate-page {
            padding: 1.5rem;
        }

        .step-container {
            padding: 2rem;
        }

        .step-container[data-step="2"] {
            padding: 2rem;
        }

        .template-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .template-item {
            border-radius: 10px;
        }

        .step-title {
            font-size: 1.75rem;
        }

        .step-description {
            font-size: 0.95rem;
        }

        .certificate-editor {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .form-row {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 600px) {
        .certificate-page {
            padding: 1rem;
        }

        .step-container {
            padding: 1.5rem;
        }

        .step-container[data-step="2"] {
            padding: 1.5rem;
        }

        .template-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .template-item {
            max-width: 280px;
            margin: 0 auto;
        }

        .step-header {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }

        .step-number {
            align-self: center;
        }

        .step-actions {
            flex-direction: column;
            align-items: center;
        }

        .btn-primary, .btn-secondary {
            width: 100%;
            max-width: 280px;
        }

        .cert-main-title {
            font-size: 1.5rem;
        }

        .recipient-name {
            font-size: 1.2rem;
        }

        .cert-background {
            padding: 1rem;
        }

        .cert-border {
            padding: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // State management
    let currentStep = 1;
    let selectedDesign = 'professional';
    let selectedTemplate = null;
    let certificateData = {
        recipientName: '',
        certificateText: '',
        signatureText: '{% if language == "ru" %}–° —É–≤–∞–∂–µ–Ω–∏–µ–º, Green Mile{% elif language == "kz" %}“ö“±—Ä–º–µ—Ç–ø–µ–Ω, Green Mile{% else %}With respect, Green Mile{% endif %}',
        treeCount: 10,
        customerName: '',
        customerEmail: '',
        customerPhone: '',
        currency: 'KZT'
    };

    const templatesByDesign = JSON.parse('{{ templates_by_design_json|escapejs }}');
    console.log('templatesByDesign:', templatesByDesign); // Debug: Check template data

    const exchangeRates = {
        KZT: 1,
        USD: 0.0021,
        EUR: 0.0019,
        RUB: 0.19
    };

    // Elements
    const steps = document.querySelectorAll('.js-step-container');
    const nextButtons = document.querySelectorAll('.js-step-next');
    const prevButtons = document.querySelectorAll('.js-step-prev');
    const designCards = document.querySelectorAll('.js-design-card');
    const templateGrid = document.querySelector('.js-template-grid');

    // Form elements
    const recipientNameInput = document.getElementById('recipient-name');
    const certificateTextInput = document.getElementById('certificate-text');
    const signatureTextInput = document.getElementById('signature-text');
    const treeCountInput = document.getElementById('tree-count');
    const currencySelect = document.getElementById('currency');
    const paymentForm = document.getElementById('payment-form');
    
    // Live preview elements
    const liveRecipientName = document.getElementById('live-recipient-name');
    const liveCertText = document.getElementById('live-cert-text');
    const liveSignature = document.getElementById('live-signature');
    const liveTreeCount = document.getElementById('live-tree-count');
    const treeLabel = document.getElementById('tree-label');
    const certNumber = document.getElementById('cert-number');
    
    // Summary elements
    const summaryTrees = document.getElementById('summary-trees');
    const summaryTotal = document.getElementById('summary-total');

    const templateUrls = {
        {% for design, template in certificate_templates.items %}
        '{{ design }}': '{{ template.background_image.url }}',
        {% endfor %}
    };
    
    const fallbackUrls = {
        'professional': '{% static "img/default-professional.jpg" %}',
        'modern': '{% static "img/default-modern.jpg" %}', 
        'elegant': '{% static "img/default-elegant.jpg" %}'
    };
    
    function getTemplateUrl(design) {
        if (templateUrls[design] && templateUrls[design] !== 'None') {
            return templateUrls[design];
        }
        return fallbackUrls[design] || '';
    }

    // Russian pluralization for "–¥–µ—Ä–µ–≤–æ"
    function getRussianTreeLabel(count) {
        const lastDigit = count % 10;
        const lastTwoDigits = count % 100;
        
        if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
            return '–¥–µ—Ä–µ–≤—å–µ–≤';
        }
        if (lastDigit === 1) {
            return '–¥–µ—Ä–µ–≤–æ';
        }
        if (lastDigit >= 2 && lastDigit <= 4) {
            return '–¥–µ—Ä–µ–≤–∞';
        }
        return '–¥–µ—Ä–µ–≤—å–µ–≤';
    }

    // Initialize
    function init() {
        updateCertificateNumber();
        setupEventListeners();
        updateLivePreview();
        updateSummary();
        selectDesign('professional'); // Ensure initial design is set
    }

    function setupEventListeners() {
        // Step navigation
        nextButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                console.log('Next button clicked, currentStep:', currentStep, 'selectedTemplate:', selectedTemplate); // Debug
                nextStep();
            });
        });
        prevButtons.forEach(btn => btn.addEventListener('click', prevStep));

        // Design selection
        designCards.forEach(card => {
            card.addEventListener('click', () => {
                console.log('Design selected:', card.dataset.design); // Debug
                selectDesign(card.dataset.design);
            });
        });

        // Form inputs
        recipientNameInput?.addEventListener('input', updateRecipientName);
        certificateTextInput?.addEventListener('input', updateCertificateText);
        signatureTextInput?.addEventListener('input', updateSignatureText);
        treeCountInput?.addEventListener('input', updateTreeCount);
        currencySelect?.addEventListener('change', updateCurrency);

        // Character counters
        setupCharacterCounters();

        // Payment form
        paymentForm?.addEventListener('submit', handlePayment);

        // Download certificate
        document.querySelector('.js-download-certificate')?.addEventListener('click', downloadCertificate);

        // Share buttons
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', (e) => shareAchievement(e.target.dataset.platform));
        });
    }

    function setupCharacterCounters() {
        const inputs = [recipientNameInput, certificateTextInput, signatureTextInput];
        inputs.forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    const counter = this.parentElement.querySelector('.char-counter');
                    const maxLength = this.getAttribute('maxlength');
                    if (counter && maxLength) {
                        counter.textContent = `${this.value.length}/${maxLength}`;
                        counter.style.color = this.value.length > maxLength * 0.9 ? '#ef4444' : '#6b7280';
                    }
                });
            }
        });
    }

    function showStep(step) {
        currentStep = step;
        steps.forEach(s => {
            s.style.display = s.dataset.step == step ? 'block' : 'none';
        });
        
        if (step === 2) {
            console.log('Showing Step 2, loading templates for:', selectedDesign); // Debug
            loadTemplatesForDesign(selectedDesign);
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function nextStep() {
        if (currentStep < 4) {
            if (validateCurrentStep()) {
                showStep(currentStep + 1);
            } else {
                console.log('Validation failed for step:', currentStep); // Debug
            }
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }

    function validateCurrentStep() {
        switch (currentStep) {
            case 1:
                console.log('Validating Step 1, selectedDesign:', selectedDesign); // Debug
                return true;
            case 2:
                return validateTemplateSelection();
            case 3:
                return validateCertificateData();
            case 4:
                return validatePaymentData();
            default:
                return true;
        }
    }

    function validateTemplateSelection() {
        console.log('Validating template selection, selectedTemplate:', selectedTemplate); // Debug
        if (!selectedTemplate) {
            alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == "kz" %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç “Ø–ª–≥—ñ—Å—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑{% else %}Please select a certificate template{% endif %}');
            return false;
        }
        return true;
    }

    function validateCertificateData() {
        if (!certificateData.recipientName.trim()) {
            alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == "kz" %}–ê–ª—É—à—ã–Ω—ã“£ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Please enter recipient name{% endif %}');
            return false;
        }
        return true;
    }

    function validatePaymentData() {
        const customerName = document.getElementById('customer-name').value.trim();
        const customerEmail = document.getElementById('customer-email').value.trim();
        const privacyConsent = document.getElementById('privacy-consent').checked;

        if (!customerName) {
            alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è{% elif language == "kz" %}–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Please enter your name{% endif %}');
            return false;
        }

        if (!customerEmail || !isValidEmail(customerEmail)) {
            alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email{% elif language == "kz" %}–î“±—Ä—ã—Å email –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Please enter a valid email{% endif %}');
            return false;
        }

        if (!privacyConsent) {
            alert('{% if language == "ru" %}–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö{% elif language == "kz" %}–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ ”©“£–¥–µ—É–≥–µ –∫–µ–ª—ñ—Å—ñ–º “õ–∞–∂–µ—Ç{% else %}Privacy consent is required{% endif %}');
            return false;
        }

        return true;
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function selectDesign(design) {
        selectedDesign = design;
        selectedTemplate = null; // Reset template when design changes
        designCards.forEach(card => {
            card.classList.toggle('active', card.dataset.design === design);
        });
        console.log('Selected design:', design, 'Reset selectedTemplate:', selectedTemplate); // Debug
        // Load templates immediately if on Step 2, otherwise load when Step 2 is shown
        if (currentStep === 2) {
            loadTemplatesForDesign(design);
        }
        // Ensure Next button is enabled for Step 1, as design selection is valid
        const nextButton = document.querySelector('.js-step-container[data-step="1"] .js-step-next');
        if (nextButton) {
            nextButton.disabled = false;
            console.log('Next button enabled for Step 1'); // Debug
        }
    }

    
    function loadTemplatesForDesign(design) {
        const templates = templatesByDesign[design] || [];
        console.log(`Loading templates for ${design}:`, templates);
        
        if (!templateGrid) {
            console.error('Template grid element not found');
            return;
        }
        
        templateGrid.innerHTML = '';
        
        if (templates.length === 0) {
            console.warn(`No templates available for ${design}`);
            templateGrid.innerHTML = `
                <div class="no-templates">
                    <div class="no-templates-icon">üìÑ</div>
                    <p>{% if language == "ru" %}–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤{% elif language == "kz" %}“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ “Ø–ª–≥—ñ–ª–µ—Ä –∂–æ“õ{% else %}No templates available{% endif %}</p>
                    <p class="no-templates-help">{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –¥–∏–∑–∞–π–Ω{% elif language == "kz" %}–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ –∫”©—Ä—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –±–∞—Å“õ–∞ –¥–∏–∑–∞–π–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑{% else %}Please try again later or choose another design{% endif %}</p>
                </div>
            `;
            return;
        }

        templates.forEach((template, index) => {
            const templateItem = document.createElement('div');
            const isSelected = index === 0;
            
            // Handle missing background images
            let imageUrl = template.background_image;
            if (!imageUrl || imageUrl === 'None') {
                imageUrl = fallbackUrls[design] || '';
            }
            
            templateItem.className = 'template-item' + (isSelected ? ' selected' : '');
            templateItem.dataset.templateId = String(template.id);
            
            templateItem.innerHTML = `
                <div class="template-image-container">
                    <img class="template-preview" src="${imageUrl}" 
                        alt="${template.name || template.variation || 'Template ' + (index + 1)}"
                        onerror="this.src='${fallbackUrls[design] || ''}'">
                    ${!imageUrl ? '<div class="template-placeholder">üå±</div>' : ''}
                </div>
                <div class="template-info">
                    <h4>${template.name || template.variation || `Template ${index + 1}`}</h4>
                    ${template.description ? `<p>${template.description}</p>` : ''}
                </div>
            `;
            
            templateItem.addEventListener('click', () => {
                selectTemplate(template, index);
            });
            
            templateGrid.appendChild(templateItem);
        });
    }

    function selectTemplate(template, index) {
        selectedTemplate = template;
        document.querySelectorAll('.template-item').forEach(item => {
            const isSelected = item.dataset.templateId === String(template.id);
            item.classList.toggle('selected', isSelected);
            item.setAttribute('aria-selected', isSelected ? 'true' : 'false');
        });
        console.log('Selected template:', selectedTemplate); // Debug
        const nextButton = document.querySelector('.js-step-container[data-step="2"] .js-step-next');
        if (nextButton) {
            nextButton.disabled = false;
            console.log('Next button enabled after template selection'); // Debug
        }
        updateCertificateStyle();
    }

    function updateCertificateStyle() {
        const certificate = document.getElementById('live-certificate');
        if (certificate && selectedTemplate) {
            certificate.className = `certificate-live ${selectedDesign}-cert`;
            if (selectedTemplate.background_image) {
                certificate.style.backgroundImage = `url('${selectedTemplate.background_image}')`;
                certificate.style.backgroundSize = 'cover';
                certificate.style.backgroundPosition = 'center';
            } else {
                certificate.style.backgroundImage = `url('${getTemplateUrl(selectedDesign)}')`;
            }
            console.log('Updated certificate style, background:', certificate.style.backgroundImage); // Debug
        } else {
            console.warn('Certificate element or selectedTemplate missing:', { certificate, selectedTemplate }); // Debug
        }
    }

    function updateRecipientName() {
        certificateData.recipientName = recipientNameInput.value;
        updateLivePreview();
    }

    function updateCertificateText() {
        certificateData.certificateText = certificateTextInput.value;
        updateLivePreview();
    }

    function updateSignatureText() {
        certificateData.signatureText = signatureTextInput.value;
        updateLivePreview();
    }

    function updateTreeCount() {
        certificateData.treeCount = parseInt(treeCountInput.value) || 10;
        updateLivePreview();
        updateSummary();
    }

    function updateCurrency() {
        certificateData.currency = currencySelect.value;
        updateSummary();
    }

    function updateLivePreview() {
        if (liveRecipientName) {
            liveRecipientName.textContent = certificateData.recipientName || 
                '{% if language == "ru" %}[–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è]{% elif language == "kz" %}[–ê–ª—É—à—ã –∞—Ç—ã]{% else %}[Recipient Name]{% endif %}';
        }

        if (liveCertText) {
            liveCertText.textContent = certificateData.certificateText || 
                '{% if language == "ru" %}–∑–∞ –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –∏ –∑–∞—â–∏—Ç—É –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã{% elif language == "kz" %}“ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É –∂”ô–Ω–µ “õ–æ—Ä—à–∞“ì–∞–Ω –æ—Ä—Ç–∞–Ω—ã “õ–æ—Ä“ì–∞—É–¥–∞“ì—ã “Ø–ª–µ—Å—ñ “Ø—à—ñ–Ω{% else %}for contributing to Kazakhstan\'s forest restoration and environmental protection{% endif %}';
        }

        if (liveSignature) {
            liveSignature.textContent = certificateData.signatureText;
        }

        if (liveTreeCount) {
            liveTreeCount.textContent = certificateData.treeCount;
        }

        if (treeLabel) {
            const language = '{{ language }}';
            if (language === 'ru') {
                treeLabel.textContent = getRussianTreeLabel(certificateData.treeCount);
            } else if (language === 'kz') {
                treeLabel.textContent = '–ê“ì–∞—à—Ç–∞—Ä —Å–∞–Ω—ã';
            } else {
                treeLabel.textContent = 'Number of trees';
            }
        }
    }

    function updateSummary() {
        const trees = certificateData.treeCount;
        const totalKZT = trees * 500;
        const rate = exchangeRates[certificateData.currency] || 1;
        const total = (totalKZT * rate).toFixed(2);

        if (summaryTrees) summaryTrees.textContent = trees;
        if (summaryTotal) summaryTotal.textContent = `${total} ${certificateData.currency}`;
    }

    function updateCertificateNumber() {
        if (certNumber) {
            const number = String(Date.now()).slice(-6);
            certNumber.textContent = number.padStart(6, '0');
        }
    }

    async function handlePayment(e) {
        e.preventDefault();
        
        if (!validatePaymentData()) return;

        const submitBtn = e.target.querySelector('.btn-pay');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoader = submitBtn.querySelector('.btn-loader');

        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline-block';

        try {
            const formData = {
                customerName: document.getElementById('customer-name').value,
                customerEmail: document.getElementById('customer-email').value,
                customerPhone: document.getElementById('customer-phone').value || '',
                recipientName: certificateData.recipientName,
                certificateText: certificateData.certificateText,
                signatureText: certificateData.signatureText,
                treeCount: certificateData.treeCount,
                selectedTemplateId: selectedTemplate?.id,
                selectedDesign: selectedDesign,
                currency: certificateData.currency,
                totalAmount: (certificateData.treeCount * 500 * (exchangeRates[certificateData.currency] || 1)).toFixed(2)
            };

            console.log('Submitting payment data:', formData); // Debug

            const response = await fetch('/api/create-certificate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                await processPayment(formData);
            } else {
                throw new Error(result.error || 'Server error');
            }
        } catch (error) {
            console.error('Payment error:', error);
            alert('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞: {% elif language == "kz" %}–¢”©–ª–µ–º–¥—ñ ”©“£–¥–µ—É “õ–∞—Ç–µ—Å—ñ: {% else %}Payment processing error: {% endif %}' + error.message);
            
            submitBtn.disabled = false;
            btnText.style.display = 'inline-block';
            btnLoader.style.display = 'none';
        }
    }

    async function processPayment(formData) {
        if (typeof cp === 'undefined' || !cp.CloudPayments) {
            throw new Error('Payment system not loaded');
        }

        const widget = new cp.CloudPayments();
        const amount = parseFloat(formData.totalAmount);

        widget.pay('charge', {
            publicId: 'test_api_00000000000000000000001',
            description: `{% if language == "ru" %}–ü–æ—Å–∞–¥–∫–∞ ${formData.treeCount} ${getRussianTreeLabel(formData.treeCount)} - Green Mile{% elif language == "kz" %}${formData.treeCount} –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑—É - Green Mile{% else %}Planting ${formData.treeCount} trees - Green Mile{% endif %}`,
            amount: amount,
            currency: formData.currency,
            accountId: formData.customerEmail,
            invoiceId: `GM${Date.now()}`,
            skin: 'modern',
            data: formData
        }, {
            onSuccess: async function(options) {
                try {
                    const response = await fetch('/api/payment-success/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            ...formData,
                            paymentId: options.transactionId,
                            status: 'completed'
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showStep(5);
                    } else {
                        throw new Error(result.error || 'Payment processing failed');
                    }
                } catch (error) {
                    console.error('Post-payment processing error:', error);
                    showStep(5);
                }
            },
            onFail: function(reason, options) {
                console.error('Payment failed:', reason);
                alert('{% if language == "ru" %}–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞: {% elif language == "kz" %}–¢”©–ª–µ–º ”©—Ç–ø–µ–¥—ñ: {% else %}Payment failed: {% endif %}' + reason);
                
                const submitBtn = document.querySelector('.btn-pay');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoader = submitBtn.querySelector('.btn-loader');
                
                submitBtn.disabled = false;
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
            }
        });
    }

    function downloadCertificate() {
        const step3Container = document.querySelector('.js-step-container[data-step="3"]');
        const certificate = document.getElementById('live-certificate');

        if (!step3Container || !certificate) {
            console.error('Certificate elements not found');
            alert('Error generating certificate. Please try again or contact support.');
            return;
        }

        const originalStepDisplay = step3Container.style.display;
        const originalCertPosition = certificate.style.position;
        const originalCertLeft = certificate.style.left;
        const originalCertTop = certificate.style.top;

        try {
            step3Container.style.display = 'block';
            certificate.style.position = 'absolute';
            certificate.style.left = '-9999px';
            certificate.style.top = '0px';

            html2canvas(certificate, {
                scale: 2,
                backgroundColor: '#ffffff',
                width: certificate.offsetWidth,
                height: certificate.offsetHeight,
                logging: false
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', [210, 297]);

                const pageWidth = 210;
                const pageHeight = 297;

                pdf.addImage(
                    canvas.toDataURL('image/png'),
                    'PNG',
                    0,
                    0,
                    pageWidth,
                    pageHeight
                );

                const certNumber = document.querySelector('#cert-number') || { textContent: 'Unknown' };
                pdf.save(`GreenMile_Certificate_${certNumber.textContent}.pdf`);
            }).catch(error => {
                console.error('html2canvas error:', error);
                alert('Error generating PDF. Please try again.');
            });
        } finally {
            step3Container.style.display = originalStepDisplay;
            certificate.style.position = originalCertPosition;
            certificate.style.left = originalCertLeft;
            certificate.style.top = originalCertTop;
        }
    }

    function shareAchievement(platform) {
        const text = `{% if language == "ru" %}–Ø –ø–æ—Å–∞–¥–∏–ª(–∞) ${certificateData.treeCount} ${getRussianTreeLabel(certificateData.treeCount)} —Å Green Mile! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.{% elif language == "kz" %}–ú–µ–Ω Green Mile –∞—Ä“õ—ã–ª—ã ${certificateData.treeCount} –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑–¥—ã–º! “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–≥–µ “õ–æ—Å—ã–ª—ã“£—ã–∑.{% else %}I planted ${certificateData.treeCount} trees with Green Mile! Join Kazakhstan's forest restoration.{% endif %}`;
        const url = window.location.origin;
        
        const shareUrls = {
            telegram: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,
            whatsapp: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`,
            facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`
        };
        
        if (shareUrls[platform]) {
            window.open(shareUrls[platform], '_blank', 'width=600,height=400');
        }
    }

    function getCsrfToken() {
        let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!token) {
            token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
        }
        if (!token) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                token = metaTag.getAttribute('content');
            }
        }
        if (!token) {
            console.warn('CSRF token not found');
            return '';
        }
        return token;
    }

    VanillaTilt.init(document.getElementById('live-certificate'), {
        max: 15,
        speed: 400,
        glare: true,
        'max-glare': 0.3,
        perspective: 1000,
        scale: 1.02,
        gyroscope: false
    });

    init();
});
</script>
{% endblock %}