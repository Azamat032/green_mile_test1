{% extends "basement/base.html" %}
{% load static %}
{% load custom_filters %}

{% block header_section %}
<script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
{% endblock %}

{% block style %}
.nav-link-white {
    color: #16a34a; /* White for Home and Organizations */
}

.nav-link-green {
    color: white; /* Green for other links */
}
.nav-link-blue{
    color: deepskyblue;
}
.logo-link{
    color: #16a34a;
}
{% endblock style %}


{% block content %}
<div class="certificate-page">
    <div class="page-header">
        <h1 class="page-title">
            {% if language == 'ru' %}–ù–∞—à –ª–µ—Å –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–ù–∞—à –ª–µ—Å –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã{% else %}–ù–∞—à –ª–µ—Å Certificate{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ—Å–∞–¥–∫–∏ –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏ –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç–∞—Ä—ã{% else %}Professional tree planting certificates{% endif %}
        </p>
    </div>

    <!-- Step 1: Design Selection -->
    <div class="step-container js-step-container" data-step="1" style="display: block;">
        <div class="step-header">
            <div class="step-number">1</div>
            <h2 class="step-title">
                {% if language == 'ru' %}–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–∏–∑–∞–π–Ω—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑{% else %}Choose certificate design{% endif %}
            </h2>
        </div>
        
        <div class="design-grid">
            <div class="design-card active js-design-card" data-design="professional">
                <div class="design-preview">   
                    <div class="cert-preview cert-professional" 
                        style="background-image: url('{% if certificate_templates.professional.background_image %}{{ certificate_templates.professional.background_image.url }}{% else %}{% static 'img/default-professional.jpg' %}{% endif %}'); 
                        background-size: cover; background-position: center;"
                    >                  
                        <div class="cert-header">
                            <div class="cert-logo">üå±</div>
                            <div class="cert-title">–ù–∞—à –ª–µ—Å </div>
                        </div>
                        <div class="cert-main-title">CERTIFICATE</div>
                        <div class="cert-content">
                            <div class="cert-text">Sample certificate text</div>
                            <div class="cert-signature">Signature</div>
                        </div>
                    </div>
                </div>
                <div class="design-info">
                    <h3>{% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏{% else %}Professional{% endif %}</h3>
                    <p>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤{% elif language == 'kz' %}–†–µ—Å–º–∏ –∂–∞“ì–¥–∞–π–ª–∞—Ä “Ø—à—ñ–Ω ”ô–¥–µ–º—ñ –¥–∏–∑–∞–π–Ω{% else %}Elegant design for official occasions{% endif %}</p>
                </div>
            </div>

            <div class="design-card js-design-card" data-design="modern">
                <div class="design-preview">
                    <div class="cert-preview cert-modern" 
                        style="background-image: url('{% if certificate_templates.modern.background_image %}{{ certificate_templates.modern.background_image.url }}{% else %}{% static 'img/default-modern.jpg' %}{% endif %}'); 
                        background-size: cover; background-position: center;"
                    >
                        <div class="cert-header-modern">
                            <div class="cert-badge">üèÜ</div>
                            <div class="cert-title-modern">ACHIEVEMENT</div>
                        </div>
                        <div class="cert-main-title-modern">GREEN CERTIFICATE</div>
                        <div class="cert-content-modern">
                            <div class="cert-text-modern">Sample text</div>
                            <div class="cert-signature-modern">Signature</div>
                        </div>
                    </div>
                </div>
                <div class="design-info">
                    <h3>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏{% else %}Modern{% endif %}</h3>
                    <p>{% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å{% elif language == 'kz' %}“ö–∞–∑—ñ—Ä–≥—ñ –∑–∞–º–∞–Ω“ì—ã –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç—ñ–∫ —Å—Ç–∏–ª—å{% else %}Contemporary minimalist style{% endif %}</p>
                </div>
            </div>

            <div class="design-card js-design-card" data-design="elegant">
                <div class="design-preview">
                    <div class="cert-preview cert-elegant" 
                        style="background-image: url('{% if certificate_templates.elegant.background_image %}{{ certificate_templates.elegant.background_image.url }}{% else %}{% static 'img/default-elegant.jpg' %}{% endif %}'); 
                        background-size: cover; background-position: center;"
                    >
                        <div class="cert-border-elegant">
                            <div class="cert-header-elegant">–ù–∞—à –ª–µ—Å </div>
                            <div class="cert-main-title-elegant">Certificate of Appreciation</div>
                            <div class="cert-content-elegant">
                                <div class="cert-text-elegant">Sample certificate</div>
                                <div class="cert-signature-elegant">Signature</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="design-info">
                    <h3>{% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π{% elif language == 'kz' %}–°”ô–Ω–¥—ñ{% else %}Elegant{% endif %}</h3>
                    <p>{% if language == 'ru' %}–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω —Å –æ—Ä–Ω–∞–º–µ–Ω—Ç–∞–º–∏{% elif language == 'kz' %}–û—é-”©—Ä–Ω–µ–∫—Ç—ñ –∫–ª–∞—Å—Å–∏–∫–∞–ª—ã“õ –¥–∏–∑–∞–π–Ω{% else %}Classic design with ornaments{% endif %}</p>
                </div>
            </div>
        </div>

        <div class="step-actions">
            <button class="btn-primary js-step-next">
                {% if language == 'ru' %}–î–∞–ª–µ–µ{% elif language == 'kz' %}”ò—Ä—ñ “õ–∞—Ä–∞–π{% else %}Next{% endif %}
            </button>
        </div>
    </div>

    <!-- Step 2: Template Selection -->
    <div class="step-container js-step-container" data-step="2" style="display: none;">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-header-content">
                <h2 class="step-title">
                    {% if language == 'ru' %}–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω{% elif language == 'kz' %}“Æ–ª–≥—ñ–Ω—ñ —Ç–∞“£–¥–∞“£—ã–∑{% else %}Choose template{% endif %}
                </h2>
                <p class="step-description">
                    {% if language == 'ru' %}–í—ã–±–µ—Ä–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã“£—ã–∑ “Ø—à—ñ–Ω —Ç–∞–º–∞–¥–∞ –¥–∏–∑–∞–π–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑{% else %}Select the perfect design for your certificate{% endif %}
                </p>
            </div>
        </div>

        <div class="template-grid js-template-grid">
            <!-- Templates will be loaded dynamically via JavaScript -->
        </div>

        <div class="step-actions">
            <button class="btn-secondary js-step-prev">
                {% if language == 'ru' %}–ù–∞–∑–∞–¥{% elif language == 'kz' %}–ê—Ä—Ç“õ–∞{% else %}Back{% endif %}
            </button>
            <button class="btn-primary js-step-next" disabled>
                {% if language == 'ru' %}–î–∞–ª–µ–µ{% elif language == 'kz' %}”ò—Ä—ñ “õ–∞—Ä–∞–π{% else %}Next{% endif %}
            </button>
        </div>
    </div>
    
    <!-- Step 3: Certificate Content -->
    <div class="step-container js-step-container" data-step="3" style="display: none;">
        <div class="step-header">
            <div class="step-number">3</div>
            <h2 class="step-title">
                {% if language == 'ru' %}–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑{% else %}Fill the certificate{% endif %}
            </h2>
        </div>

        <div class="certificate-editor">
            <div class="editor-controls">
                <div class="form-group">
                    <label for="recipient-name">
                        {% if language == 'ru' %}–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == 'kz' %}–ê–ª—É—à—ã–Ω—ã“£ –∞—Ç—ã{% else %}Recipient name{% endif %}
                    </label>
                    <input type="text" id="recipient-name" class="form-control" maxlength="50" 
                           placeholder="{% if language == 'ru' %}–í–≤–µ–¥–∏—Ç–µ –∏–º—è{% elif language == 'kz' %}–ê—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Enter name{% endif %}">
                    <small class="char-counter">0/50</small>
                </div>

                <div class="form-group">
                    <label for="certificate-text">
                        {% if language == 'ru' %}–¢–µ–∫—Å—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –º”ô—Ç—ñ–Ω—ñ{% else %}Certificate text{% endif %}
                    </label>
                    <textarea id="certificate-text" class="form-control" rows="4" maxlength="300"
                              placeholder="{% if language == 'ru' %}–∑–∞ –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞...{% elif language == 'kz' %}“ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–¥–µ–≥—ñ “Ø–ª–µ—Å—ñ “Ø—à—ñ–Ω...{% else %}for contributing to Kazakhstan's forest restoration...{% endif %}"></textarea>
                    <small class="char-counter">0/300</small>
                </div>

                <div class="form-group">
                    <label for="signature-text">
                        {% if language == 'ru' %}–ü–æ–¥–ø–∏—Å—å{% elif language == 'kz' %}“ö–æ–ª—Ç–∞“£–±–∞{% else %}Signature{% endif %}
                    </label>
                    <input type="text" id="signature-text" class="form-control" maxlength="50"
                           value="{% if language == 'ru' %}–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ù–∞—à –ª–µ—Å {% elif language == 'kz' %}“ö“±—Ä–º–µ—Ç–ø–µ–Ω, –ù–∞—à –ª–µ—Å {% else %}With respect, –ù–∞—à –ª–µ—Å {% endif %}">
                    <small class="char-counter">0/50</small>
                </div>

                <div class="form-group">
                    <label for="tree-count">
                        {% if language == 'ru' %}–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–ê“ì–∞—à —Å–∞–Ω—ã{% else %}Number of trees{% endif %}
                    </label>
                    <input type="number" id="tree-count" class="form-control" min="10" value="10">
                </div>
            </div>

            <div class="certificate-preview">
                <div id="live-certificate" class="certificate-live professional-cert" style="aspect-ratio: 210 / 297; width: 100%; max-width: 420px; background-image: url('{% static 'img/default-professional.jpg' %}'); background-size: cover; background-position: center;">
                    <div class="cert-background">
                        <div class="cert-border">
                            <div class="cert-header-section">
                                <div class="cert-logo-section">
                                    <div class="logo-icon">
                                        <img src="{% static 'img/logo-white.png' %}" alt="Tree" />
                                    
                                    </div>
                                    <div class="org-name">–ù–∞—à –ª–µ—Å </div>
                                </div>
                                <div class="cert-number">‚Ññ <span id="cert-number">000001</span> / {% now "d.m.Y" %}</div>
                            </div>
                            
                            <div class="cert-main-section">
                                <h1 class="cert-main-title">
                                    {% if language == 'ru' %}–ë–õ–ê–ì–û–î–ê–†–ù–û–°–¢–¨{% elif language == 'kz' %}–ê–õ“í–´–° –•–ê–¢{% else %}CERTIFICATE OF APPRECIATION{% endif %}
                                </h1>
                                
                                <div class="cert-subtitle">
                                    {% if language == 'ru' %}–ó–∞ –≤–∫–ª–∞–¥ –≤ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ{% elif language == 'kz' %}–ñ–∞—Å—ã–ª –±–æ–ª–∞—à–∞“õ“õ–∞ “Ø–ª–µ—Å “õ–æ—Å“õ–∞–Ω—ã “Ø—à—ñ–Ω{% else %}For a Contribution to a Greener Future{% endif %}
                                </div>
                                
                                <div class="recipient-section">
                                    <div class="recipient-label">
                                        {% if language == 'ru' %}–ù–∞–≥—Ä–∞–∂–¥–∞–µ—Ç—Å—è{% elif language == 'kz' %}–ú–∞—Ä–∞–ø–∞—Ç—Ç–∞–ª–∞–¥—ã{% else %}This certificate is proudly presented to{% endif %}
                                    </div>
                                    <div class="recipient-name" id="live-recipient-name">
                                        {% if language == 'ru' %}–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == 'kz' %}–ê–ª—É—à—ã –∞—Ç—ã{% else %}Recipient Name{% endif %}
                                    </div>
                                </div>
                                
                                <div class="achievement-section">
                                    <div class="tree-info">
                                        <span class="tree-count-display" id="live-tree-count">10</span>
                                        <span class="tree-label" id="tree-label">
                                            {% if language == 'ru' %}–¥–µ—Ä–µ–≤–æ{% elif language == 'kz' %}–ê“ì–∞—à—Ç–∞—Ä —Å–∞–Ω—ã{% else %}Number of trees{% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="cert-description" id="live-cert-text">
                                        {% if language == 'ru' %}–±—ã–ª–æ –ø–æ—Å–∞–∂–µ–Ω–æ –≤ –í–∞—à–µ –∏–º—è, –≤–Ω–æ—Å—è –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑–¥–∞–Ω “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–≥–µ “õ–æ—Å“õ–∞–Ω “Ø–ª–µ—Å—ñ“£—ñ–∑ “Ø—à—ñ–Ω.{% else %}has been planted in your name, supporting forest restoration in Kazakhstan.{% endif %}
                                    </div>
                                </div>
                                
                                <div class="signature-section">
                                    <div class="signature-line">
                                        <div class="signature-text" id="live-signature">
                                            {% if language == 'ru' %}–° –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é, –ö–æ–º–∞–Ω–¥–∞ –ù–∞—à –ª–µ—Å {% elif language == 'kz' %}–ê–ª“ì—ã—Å –±—ñ–ª–¥—ñ—Ä–µ –æ—Ç—ã—Ä—ã–ø, –ù–∞—à –ª–µ—Å“±–∂—ã–º—ã{% else %}With Gratitude, The –ù–∞—à –ª–µ—ÅTeam{% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="cert-footer">
                                    <div class="website">greenmile.kz</div>
                                    <div class="impact-text">
                                        {% if language == 'ru' %}–í–º–µ—Å—Ç–µ –º—ã —Å–æ–∑–¥–∞—ë–º –∑–µ–ª—ë–Ω–æ–µ –±—É–¥—É—â–µ–µ.{% elif language == 'kz' %}–ë—ñ—Ä–≥–µ –±—ñ–∑ –∂–∞—Å—ã–ª –±–æ–ª–∞—à–∞“õ—Ç—ã “õ“±—Ä–∞–º—ã–∑.{% else %}Together, we are growing a greener tomorrow.{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-actions">
            <button class="btn-secondary js-step-prev">
                {% if language == 'ru' %}–ù–∞–∑–∞–¥{% elif language == 'kz' %}–ê—Ä—Ç“õ–∞{% else %}Back{% endif %}
            </button>
            <button class="btn-primary js-step-next">
                {% if language == 'ru' %}–î–∞–ª–µ–µ{% elif language == 'kz' %}”ò—Ä—ñ “õ–∞—Ä–∞–π{% else %}Next{% endif %}
            </button>
        </div>
    </div> 

    <!-- Step 4: Payment -->
    <div class="step-container js-step-container" data-step="4" style="display: none;">
        <div class="step-header">
            <div class="step-number">4</div>
            <h2 class="step-title">
                {% if language == 'ru' %}–û–ø–ª–∞—Ç–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ{% elif language == 'kz' %}–¢”©–ª–µ–º –∂”ô–Ω–µ –±–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ{% else %}Payment and contact details{% endif %}
            </h2>
        </div>

        <form id="payment-form" class="payment-form">
            <input type="hidden" id="template-id" name="template_id" value="">
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-name">
                        {% if language == 'ru' %}–í–∞—à–µ –∏–º—è{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑{% else %}Your name{% endif %} *
                    </label>
                    <input type="text" id="customer-name" name="customerName" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="customer-email">
                        {% if language == 'ru' %}Email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∞–ª—É “Ø—à—ñ–Ω email{% else %}Email for certificate delivery{% endif %} *
                    </label>
                    <input type="email" id="customer-email" name="customerEmail" class="form-control" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="customer-phone">
                        {% if language == 'ru' %}–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ){% elif language == 'kz' %}–¢–µ–ª–µ—Ñ–æ–Ω (–º—ñ–Ω–¥–µ—Ç—Ç—ñ –µ–º–µ—Å){% else %}Phone (optional){% endif %}
                    </label>
                    <input type="tel" id="customer-phone" name="customerPhone" class="form-control">
                </div>

                <div class="form-group">
                    <label for="currency">
                        {% if language == 'ru' %}–í–∞–ª—é—Ç–∞{% elif language == 'kz' %}–í–∞–ª—é—Ç–∞{% else %}Currency{% endif %}
                    </label>
                    <select id="currency" name="currency" class="form-control">
                        <option value="KZT">KZT - –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π —Ç–µ–Ω–≥–µ</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="RUB">RUB - Russian Ruble</option>
                    </select>
                </div>
            </div>

            <div class="order-summary">
                <h3>{% if language == 'ru' %}–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ{% elif language == 'kz' %}–¢”©–ª–µ–º–≥–µ –∂–∞–ª–ø—ã{% else %}Total to pay{% endif %}</h3>
                <div class="summary-item">
                    <span>{% if language == 'ru' %}–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤:{% elif language == 'kz' %}–ê“ì–∞—à —Å–∞–Ω—ã:{% else %}Number of trees:{% endif %}</span>
                    <span id="summary-trees">10</span>
                </div>
                <div class="summary-item">
                    <span>{% if language == 'ru' %}–¶–µ–Ω–∞ –∑–∞ –¥–µ—Ä–µ–≤–æ:{% elif language == 'kz' %}–ê“ì–∞—à –±–∞“ì–∞—Å—ã:{% else %}Price per tree:{% endif %}</span>
                    <span>5000 KZT</span>
                </div>
                <div class="summary-item total">
                    <span>{% if language == 'ru' %}–ò—Ç–æ–≥–æ:{% elif language == 'kz' %}–ñ–∞–ª–ø—ã:{% else %}Total:{% endif %}</span>
                    <span id="summary-total">50000 KZT</span>
                </div>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="privacy-consent" required>
                    <span class="checkmark"></span>
                    <span class="checkbox-text">
                        {% if language == 'ru' %}–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–ö{% elif language == 'kz' %}–ú–µ–Ω “ö–† –∑–∞“£–Ω–∞–º–∞—Å—ã–Ω–∞ —Å”ô–π–∫–µ—Å –∂–µ–∫–µ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ ”©“£–¥–µ—É–≥–µ –∫–µ–ª—ñ—Å–µ–º—ñ–Ω{% else %}I agree to personal data processing in accordance with RK legislation{% endif %}
                    </span>
                </label>
            </div>

            <div class="step-actions">
                <button type="button" class="btn-secondary js-step-prev">
                    {% if language == 'ru' %}–ù–∞–∑–∞–¥{% elif language == 'kz' %}–ê—Ä—Ç“õ–∞{% else %}Back{% endif %}
                </button>
                <button type="submit" class="btn-primary btn-pay">
                    <span class="btn-text">{% if language == 'ru' %}–û–ø–ª–∞—Ç–∏—Ç—å{% elif language == 'kz' %}–¢”©–ª–µ—É{% else %}Pay Now{% endif %}</span>
                    <span class="btn-loader" style="display: none;">‚è≥</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Step 5: Success -->
    <div class="step-container js-step-container" data-step="5" style="display: none;">
        <div class="success-screen">
            <div class="success-icon">‚úÖ</div>
            <h2>{% if language == 'ru' %}–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–∫–ª–∞–¥!{% elif language == 'kz' %}“Æ–ª–µ—Å—ñ“£—ñ–∑ “Ø—à—ñ–Ω —Ä–∞—Ö–º–µ—Ç!{% else %}Thank you for your contribution!{% endif %}</h2>
            <p>{% if language == 'ru' %}–í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email.{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ —Ç”©–ª–µ–º—ñ–Ω —Å”ô—Ç—Ç—ñ ”©“£–¥–µ–ª–¥—ñ. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫”©—Ä—Å–µ—Ç—ñ–ª–≥–µ–Ω email-–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ.{% else %}Your payment has been processed successfully. Certificate has been sent to your email.{% endif %}</p>
            
            <div class="download-section">
                <button class="btn-primary js-download-certificate">
                    üì• {% if language == 'ru' %}–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –∂“Ø–∫—Ç–µ–ø –∞–ª—É{% else %}Download Certificate{% endif %}
                </button>
            </div>

            <div class="share-section">
                <h3>{% if language == 'ru' %}–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º!{% elif language == 'kz' %}–ñ–µ—Ç—ñ—Å—Ç—ñ–≥—ñ“£—ñ–∑–±–µ–Ω –±”©–ª—ñ—Å—ñ“£—ñ–∑!{% else %}Share your achievement!{% endif %}</h3>
                <div class="share-buttons">
                    <button class="share-btn" data-platform="telegram">üì± Telegram</button>
                    <button class="share-btn" data-platform="whatsapp">üí¨ WhatsApp</button>
                    <button class="share-btn" data-platform="facebook">üë• Facebook</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f5f9fc 0%, #e8f5e8 100%);
    }

    .certificate-page {
        max-width: 1280px;
        margin: 0 auto;
        padding: 2rem;
        min-height: 100vh;
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a5f3f;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1.1rem;
        color: #6b7280;
        font-weight: 400;
    }

    .step-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2.5rem;
        margin-bottom: 2rem;
        position: relative;
        z-index: 1;
    }

    /* Step 2: Template Selection */
    .step-container[data-step="2"] {
        background: linear-gradient(135deg, #fffaf0 0%, #ffffff 100%);
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 1;
        overflow: visible;
    }

    .step-container[data-step="2"]::before {
        content: '';
        position: absolute;
        top: -20px;
        left: -20px;
        right: -20px;
        bottom: -20px;
        background: linear-gradient(135deg, rgba(218, 165, 32, 0.1) 0%, transparent 50%);
        z-index: -1;
        border-radius: 24px;
        border: 2px double #daa520;
    }

    .step-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .step-number {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #16a085, #2ecc71);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
    }

    .step-header-content {
        flex: 1;
    }

    .step-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        color: #1a3c34;
        margin: 0;
        font-weight: 700;
        letter-spacing: -0.025em;
    }

    .step-description {
        font-size: 1rem;
        color: #4b5e5a;
        margin: 0.5rem 0 0;
        line-height: 1.5;
        max-width: 600px;
    }

    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 2rem;
        padding: 1.5rem 0;
    }

    .template-item {
        background: #fffaf0;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        border: 2px double #daa520;
        aspect-ratio: 210 / 297;
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
    }

    .template-item:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 12px 25px rgba(22, 160, 133, 0.2);
        border-color: #16a085;
    }

    .template-item.selected {
        border-color: #16a085;
        box-shadow: 0 12px 25px rgba(22, 160, 133, 0.25), 0 0 0 4px rgba(22, 160, 133, 0.1);
        transform: scale(1.03);
    }

    .template-item.selected::after {
        content: "‚úì";
        position: absolute;
        top: 16px;
        right: 16px;
        width: 28px;
        height: 28px;
        background: #16a085;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        animation: checkmarkAppear 0.3s ease;
    }

    .template-image-container {
        position: relative;
        width: 100%;
        height: 70%;
        overflow: hidden;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
    }

    .template-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        aspect-ratio: 210 / 297;
        display: block;
        transition: transform 0.3s ease;
    }

    .template-item:hover .template-preview {
        transform: scale(1.05);
    }

    .template-placeholder {
        display: none;
        height: 100%;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #6b7280;
        text-align: center;
        padding: 1rem;
    }

    .placeholder-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .placeholder-text {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .template-info {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        background: linear-gradient(180deg, rgba(255, 250, 240, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%);
        border-top: 1px solid #e5e7eb;
    }

    .template-info h4 {
        font-family: 'Playfair Display', serif;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a3c34;
        margin: 0 0 0.5rem 0;
        letter-spacing: 0.02em;
    }

    .template-info p {
        font-size: 0.9rem;
        color: #6b7280;
        margin: 0;
        line-height: 1.4;
        font-style: italic;
    }

    .no-templates {
        text-align: center;
        font-size: 1rem;
        color: #6b7280;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #d1d5db;
    }

    .no-templates-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .no-templates-help {
        font-size: 0.9rem;
        color: #9ca3af;
    }

    .step-actions {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        position: relative;
        z-index: 1;
    }

    .btn-primary, .btn-secondary {
        padding: 0.875rem 2rem;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 160px;
        text-align: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #16a085, #2ecc71);
        color: white;
        box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(22, 160, 133, 0.4);
    }

    .btn-primary:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        box-shadow: none;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #1a3c34;
        border: 2px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
        border-color: #16a085;
        color: #16a085;
    }

    /* Design Selection */
    .design-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .design-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .design-card:hover {
        border-color: #16a085;
        box-shadow: 0 8px 20px rgba(22, 160, 133, 0.15);
    }

    .design-card.active {
        border-color: #16a085;
        background: #f0fdfa;
        box-shadow: 0 8px 20px rgba(22, 160, 133, 0.2);
    }

    .design-preview {
        margin-bottom: 1rem;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cert-preview {
        width: 250px;
        height: 160px;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        transform: scale(0.8);
    }

    /* Certificate Styles */
    .cert-professional {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #16a085;
        padding: 1rem;
    }

    .cert-modern {
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        color: white;
        padding: 1rem;
    }

    .cert-elegant {
        background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        color: white;
        padding: 1rem;
    }

    .cert-header, .cert-header-modern, .cert-header-elegant {
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .cert-logo, .cert-badge {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }

    .cert-title, .cert-title-modern, .cert-header-elegant {
        font-family: 'Playfair Display', serif;
        font-size: 1rem;
        font-weight: 700;
    }

    .cert-main-title, .cert-main-title-modern, .cert-main-title-elegant {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .cert-content, .cert-content-modern, .cert-content-elegant {
        text-align: center;
        font-size: 0.8rem;
    }

    .cert-text, .cert-text-modern, .cert-text-elegant {
        margin-bottom: 0.5rem;
    }

    .cert-signature, .cert-signature-modern, .cert-signature-elegant {
        font-style: italic;
        font-size: 0.8rem;
    }

        /* Certificate Live Preview */
    .certificate-live {
        margin: 0 auto;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        transform-style: preserve-3d;
        will-change: transform;
    }

    .certificate-live:hover {
        box-shadow: 0 30px 50px rgba(0, 0, 0, 0.2);
    }

    .cert-background {
        padding: 2rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(22, 160, 133, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(22, 160, 133, 0.05) 0%, transparent 50%);
        position: relative;
    }

    .cert-background::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(22,160,133,0.02) 10px, rgba(22,160,133,0.02) 20px);
    }

    .cert-border {
        padding: 1.5rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .cert-border::before {
        content: '';
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        border-radius: 4px;
        opacity: 0.9;
    }

    .cert-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        background: rgba(255,255,255,0.01);
        border-radius: 25px;
        padding: 0.5rem 1rem;
    }

    .cert-logo-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .logo-icon {
        font-size: 1.8rem;
    }

    .org-name {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem;
        font-weight: 700;
        color: #16a085;
    }

    .cert-number {
        font-size: 0.875rem;
        color: #6b7280;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }

    .cert-main-section {
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .cert-main-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        font-weight: 700;
        color: #1a5f3f;
        margin-bottom: 0.5rem;
        letter-spacing: 2px;
    }

    .cert-subtitle {
        font-size: 1rem;
        color: #6b7280;
        margin-bottom: 1.5rem;
        font-style: italic;
    }

    .recipient-section {
        margin-bottom: 1.5rem;
    }

    .recipient-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }

    .recipient-name {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a5f3f;
        border-bottom: 2px solid #16a085;
        padding-bottom: 0.25rem;
        display: inline-block;
        min-width: 200px;
    }

    .achievement-section {
        margin-bottom: 2rem;
    }

    .tree-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        color: #16a085;
        font-weight: 600;
        background: rgba(22,160,133,0.05);
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        box-shadow: 0 2px 10px rgba(22,160,133,0.1);
    }

    .tree-count-display {
        font-size: 2rem;
        font-weight: 700;
    }

    .cert-description {
        font-size: 1rem;
        color: #4b5e5a;
        line-height: 1.5;
        max-width: 400px;
        margin: 0 auto;
        font-style: italic;
        padding: 1rem;
        border-left: 4px solid #16a085;
    }

    .signature-section {
        margin-bottom: 1.5rem;
    }

    .signature-text {
        font-family: 'Playfair Display', serif;
        font-size: 1.1rem;
        color: #16a085;
        font-style: italic;
        border-top: 2px dashed #16a085;
        padding-top: 0.5rem;
        text-align: right;
    }

    .cert-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
        color: #6b7280;
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
        margin-top: 1rem;
        background: rgba(22,160,133,0.03);
    }

    .website {
        font-weight: 600;
        color: #16a085;
    }

    .impact-text {
        max-width: 200px;
        text-align: right;
        font-style: italic;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        background: #fafafa;
    }

    .form-control:focus {
        outline: none;
        border-color: #16a085;
        box-shadow: 0 0 0 3px rgba(22, 160, 133, 0.1);
        background: white;
    }

    .char-counter {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
        text-align: right;
    }

    /* Certificate Editor */
    .certificate-editor {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        align-items: start;
    }

    .certificate-preview {
        position: sticky;
        top: 2rem;
    }

    /* Form Rows */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    /* Order Summary */
    .order-summary {
        background: #f8fffe;
        border: 2px solid #16a085;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem 0;
    }

    .order-summary h3 {
        font-family: 'Playfair Display', serif;
        color: #1a5f3f;
        margin-bottom: 1rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e0f2f1;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-item.total {
        font-weight: 600;
        font-size: 1.2rem;
        color: #16a085;
        border-top: 2px solid #16a085;
        margin-top: 1rem;
        padding-top: 1rem;
    }

    /* Checkbox */
    .checkbox-group {
        margin: 2rem 0;
    }

    .checkbox-label {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #16a085;
        margin: 0;
    }

    /* Success Screen */
    .success-screen {
        text-align: center;
        padding: 2rem;
    }

    .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: bounce 1s ease-in-out;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }

    .success-screen h2 {
        font-family: 'Playfair Display', serif;
        color: #16a085;
        margin-bottom: 1rem;
    }

    .success-screen p {
        color: #6b7280;
        margin-bottom: 2rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    .download-section {
        margin-bottom: 2rem;
    }

    .share-section h3 {
        color: #1a5f3f;
        margin-bottom: 1rem;
    }

    .share-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .share-btn {
        padding: 0.75rem 1.5rem;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .share-btn:hover {
        border-color: #16a085;
        background: #f0fdfa;
    }

    @keyframes checkmarkAppear {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 900px) {
        .certificate-page {
            padding: 1.5rem;
        }

        .step-container {
            padding: 2rem;
        }

        .step-container[data-step="2"] {
            padding: 2rem;
        }

        .template-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .template-item {
            border-radius: 10px;
        }

        .step-title {
            font-size: 1.75rem;
        }

        .step-description {
            font-size: 0.95rem;
        }

        .certificate-editor {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .cert-main-title {
            font-size: 1.8rem;
        }

        .recipient-name {
            font-size: 1.4rem;
        }

        .tree-count-display {
            font-size: 1.8rem;
        }

        .cert-description {
            font-size: 1rem;
        }
    }

    @media (max-width: 600px) {
        .certificate-page {
            padding: 1rem;
        }

        .step-container {
            padding: 1.5rem;
        }

        .step-container[data-step="2"] {
            padding: 1.5rem;
        }

        .template-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .template-item {
            max-width: 300px;
            margin: 0 auto;
        }

        .step-header {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }

        .step-number {
            align-self: center;
        }

        .step-actions {
            flex-direction: column;
            align-items: center;
        }

        .btn-primary, .btn-secondary {
            width: 100%;
            max-width: 280px;
        }

        .cert-main-title {
            font-size: 1.5rem;
        }

        .recipient-name {
            font-size: 1.2rem;
        }

        .cert-background {
            padding: 1rem;
        }

        .cert-border {
            padding: 1rem;
        }

        .tree-count-display {
            font-size: 1.6rem;
        }

        .cert-description {
            font-size: 0.95rem;
        }

        .signature-text {
            font-size: 1rem;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    }
</style>

<script>
    document.addEventListener('error', function(e) {
        if (e.target.tagName === 'IMG') {
            console.warn('Image failed to load:', e.target.src);
            e.target.style.display = 'none';
            const placeholder = e.target.nextElementSibling;
            if (placeholder && placeholder.classList.contains('template-placeholder')) {
                placeholder.style.display = 'flex';
            }
        }
    }, true);

    document.addEventListener('DOMContentLoaded', function() {
        let currentStep = 1;
        let selectedDesign = 'professional';
        let selectedTemplate = null;
        let certificateData = {
            recipientName: '',
            certificateText: '',
            signatureText: '{% if language == "ru" %}–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ù–∞—à –ª–µ—Å {% elif language == "kz" %}“ö“±—Ä–º–µ—Ç–ø–µ–Ω, –ù–∞—à –ª–µ—Å {% else %}With respect, –ù–∞—à –ª–µ—Å {% endif %}',
            treeCount: 10,
            customerName: '',
            customerEmail: '',
            customerPhone: '',
            currency: 'KZT'
        };

        const templatesByDesign = JSON.parse('{{ templates_by_design_json|escapejs }}');
        console.log('templatesByDesign:', templatesByDesign);

        const exchangeRates = {
            KZT: 1,
            USD: 0.0021,
            EUR: 0.0019,
            RUB: 0.19
        };

        const steps = document.querySelectorAll('.js-step-container');
        const nextButtons = document.querySelectorAll('.js-step-next');
        const prevButtons = document.querySelectorAll('.js-step-prev');
        const designCards = document.querySelectorAll('.js-design-card');
        const templateGrid = document.querySelector('.js-template-grid');
        const recipientNameInput = document.getElementById('recipient-name');
        const certificateTextInput = document.getElementById('certificate-text');
        const signatureTextInput = document.getElementById('signature-text');
        const treeCountInput = document.getElementById('tree-count');
        const currencySelect = document.getElementById('currency');
        const paymentForm = document.getElementById('payment-form');
        const templateIdInput = document.getElementById('template-id');
        const liveRecipientName = document.getElementById('live-recipient-name');
        const liveCertText = document.getElementById('live-cert-text');
        const liveSignature = document.getElementById('live-signature');
        const liveTreeCount = document.getElementById('live-tree-count');
        const treeLabel = document.getElementById('tree-label');
        const certNumber = document.getElementById('cert-number');
        const summaryTrees = document.getElementById('summary-trees');
        const summaryTotal = document.getElementById('summary-total');

        function getTemplateUrl(design) {
            const fallbackUrls = {
                'professional': '{% static "img/default-professional.jpg" %}',
                'modern': '{% static "img/default-modern.jpg" %}', 
                'elegant': '{% static "img/default-elegant.jpg" %}'
            };
            return fallbackUrls[design] || '';
        }

        function getRussianTreeLabel(count) {
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;
            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return '–¥–µ—Ä–µ–≤—å–µ–≤';
            }
            if (lastDigit === 1) {
                return '–¥–µ—Ä–µ–≤–æ';
            }
            if (lastDigit >= 2 && lastDigit <= 4) {
                return '–¥–µ—Ä–µ–≤–∞';
            }
            return '–¥–µ—Ä–µ–≤—å–µ–≤';
        }

        function init() {
            updateCertificateNumber();
            setupEventListeners();
            updateLivePreview();
            updateSummary();
            selectDesign('professional');
        }

        function setupEventListeners() {
            nextButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Next button clicked, currentStep:', currentStep, 'selectedTemplate:', selectedTemplate);
                    nextStep();
                });
            });
            prevButtons.forEach(btn => btn.addEventListener('click', prevStep));

            designCards.forEach(card => {
                card.addEventListener('click', () => {
                    console.log('Design selected:', card.dataset.design);
                    selectDesign(card.dataset.design);
                });
            });

            recipientNameInput?.addEventListener('input', updateRecipientName);
            certificateTextInput?.addEventListener('input', updateCertificateText);
            signatureTextInput?.addEventListener('input', updateSignatureText);
            treeCountInput?.addEventListener('input', updateTreeCount);
            currencySelect?.addEventListener('change', updateCurrency);
            paymentForm?.addEventListener('submit', handlePayment);
            document.querySelector('.js-download-certificate')?.addEventListener('click', downloadCertificate);
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', (e) => shareAchievement(e.target.dataset.platform));
            });

            setupCharacterCounters();
        }

        function setupCharacterCounters() {
            const inputs = [recipientNameInput, certificateTextInput, signatureTextInput];
            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        const counter = this.parentElement.querySelector('.char-counter');
                        const maxLength = this.getAttribute('maxlength');
                        if (counter && maxLength) {
                            counter.textContent = `${this.value.length}/${maxLength}`;
                            counter.style.color = this.value.length > maxLength * 0.9 ? '#ef4444' : '#6b7280';
                        }
                    });
                }
            });
        }

        function showStep(step) {
            currentStep = step;
            steps.forEach(s => {
                s.style.display = s.dataset.step == step ? 'block' : 'none';
            });
            if (step === 2) {
                console.log('Showing Step 2, loading templates for:', selectedDesign);
                loadTemplatesForDesign(selectedDesign);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep() {
            if (currentStep < 4) {
                if (validateCurrentStep()) {
                    showStep(currentStep + 1);
                } else {
                    console.log('Validation failed for step:', currentStep);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    console.log("Validation Step 1, selectedDesign:", selectedDesign);
                    if (!selectedDesign) {
                        alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω{% elif language == "kz" %}–î–∏–∑–∞–π–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑{% else %}Please select a design{% endif %}');
                        return false;
                    }
                    return true;
                case 2:
                    return validateTemplateSelection();
                case 3: 
                    return validateCertificateData();
                case 4:
                    return validatePaymentData();
                default:
                    return true;
            }
        }

        function validateTemplateSelection() {
            console.log("Validating template selection, selectedTemplate:", selectedTemplate);
            if (!selectedTemplate) {
                alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == "kz" %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç “Ø–ª–≥—ñ—Å—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑{% else %}Please select a certificate template{% endif %}');
                return false;
            }
            return true;
        }

        function validateCertificateData() {
            if (!certificateData.recipientName) {
                alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == "kz" %}–ê–ª—É—à—ã–Ω—ã“£ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Please enter the recipient name{% endif %}');
                return false;
            }
            return true;
        }

        function validatePaymentData() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerEmail = document.getElementById('customer-email').value.trim();
            const privacyConsent = document.getElementById('privacy-consent').checked;

            if (!customerName) {
                alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è{% elif language == "kz" %}–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Please enter your name{% endif %}');
                return false;
            }

            if (!customerEmail || !isValidEmail(customerEmail)) {
                alert('{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email{% elif language == "kz" %}–î“±—Ä—ã—Å email –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑{% else %}Please enter a valid email{% endif %}');
                return false;
            }

            if (!privacyConsent) {
                alert('{% if language == "ru" %}–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö{% elif language == "kz" %}–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ ”©“£–¥–µ—É–≥–µ –∫–µ–ª—ñ—Å—ñ–º “õ–∞–∂–µ—Ç{% else %}Privacy consent is required{% endif %}');
                return false;
            }

            return true;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function selectDesign(design) {
            selectedDesign = design;
            selectedTemplate = null;
            designCards.forEach(card => {
                card.classList.toggle('active', card.dataset.design === design);
            });
            console.log('Selected design:', design, 'Reset selectedTemplate:', selectedTemplate);
            if (currentStep === 2) {
                loadTemplatesForDesign(design);
            }
            const nextButton = document.querySelector('.js-step-container[data-step="1"] .js-step-next');
            if (nextButton) {
                nextButton.disabled = false;
                console.log('Next button enabled for Step 1');
            }
        }

        function loadTemplatesForDesign(design) {
            const templates = templatesByDesign[design] || [];
            console.log(`Loading templates for ${design}:`, templates);
            
            if (!templateGrid) {
                console.error('Template grid element not found');
                return;
            }
            
            templateGrid.innerHTML = '';
            
            if (templates.length === 0) {
                console.warn(`No templates available for ${design}`);
                templateGrid.innerHTML = `
                    <div class="no-templates">
                        <div class="no-templates-icon">üìÑ</div>
                        <p>{% if language == "ru" %}–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤{% elif language == "kz" %}“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ “Ø–ª–≥—ñ–ª–µ—Ä –∂–æ“õ{% else %}No templates available{% endif %}</p>
                        <p class="no-templates-help">{% if language == "ru" %}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –¥–∏–∑–∞–π–Ω{% elif language == "kz" %}–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ –∫”©—Ä—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –±–∞—Å“õ–∞ –¥–∏–∑–∞–π–Ω–¥—ã —Ç–∞“£–¥–∞“£—ã–∑{% else %}Please try again later or choose another design{% endif %}</p>
                    </div>
                `;
                const nextButton = document.querySelector('.js-step-container[data-step="2"] .js-step-next');
                if (nextButton) nextButton.disabled = true;
                return;
            }

            templates.forEach((template, index) => {
                const templateItem = document.createElement('div');
                const isSelected = index === 0;
                
                let imageUrl = template.background_image || getTemplateUrl(design);
                
                templateItem.className = 'template-item' + (isSelected ? ' selected' : '');
                templateItem.dataset.templateId = String(template.id);
                
                templateItem.innerHTML = `
                    <div class="template-image-container">
                        <img class="template-preview" src="${imageUrl}" 
                            alt="${template.name || 'Template ' + (index + 1)}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="template-placeholder" style="display: none;">
                            <div class="placeholder-icon">üå±</div>
                            <div class="placeholder-text">${template.name || 'Template ' + (index + 1)}</div>
                        </div>
                    </div>
                    <div class="template-info">
                        <h4>${template.name || `${design.charAt(0).toUpperCase() + design.slice(1)} Template ${index + 1}`}</h4>
                        ${template.description ? `<p>${template.description}</p>` : ''}
                    </div>
                `;
                
                templateItem.addEventListener('click', () => {
                    selectTemplate(template, templateItem);
                });
                
                templateGrid.appendChild(templateItem);
                
                if (isSelected && !selectedTemplate) {
                    selectTemplate(template, templateItem);
                }
            });
        }

        function selectTemplate(template, templateElement) {
            selectedTemplate = template;
            templateIdInput.value = template.id;
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('selected');
            });
            templateElement.classList.add('selected');
            console.log('Selected template:', selectedTemplate);
            updateCertificateStyle();
            const nextButton = document.querySelector('.js-step-container[data-step="2"] .js-step-next');
            if (nextButton) {
                nextButton.disabled = false;
            }
        }

        function updateCertificateStyle() {
            const certificate = document.getElementById('live-certificate');
            if (certificate && selectedTemplate) {
                certificate.className = `certificate-live ${selectedDesign}-cert`;
                if (selectedTemplate.background_image) {
                    certificate.style.backgroundImage = `url('${selectedTemplate.background_image}')`;
                    certificate.style.backgroundSize = 'cover';
                    certificate.style.backgroundPosition = 'center';
                } else {
                    certificate.style.backgroundImage = `url('${getTemplateUrl(selectedDesign)}')`;
                }
                console.log('Updated certificate style, background:', certificate.style.backgroundImage);
            } else {
                console.warn('Certificate element or selectedTemplate missing:', { certificate, selectedTemplate });
            }
        }

        function updateRecipientName() {
            certificateData.recipientName = recipientNameInput.value;
            updateLivePreview();
        }

        function updateCertificateText() {
            certificateData.certificateText = certificateTextInput.value;
            updateLivePreview();
        }

        function updateSignatureText() {
            certificateData.signatureText = signatureTextInput.value;
            updateLivePreview();
        }

        function updateTreeCount() {
            certificateData.treeCount = parseInt(treeCountInput.value) || 10;
            updateLivePreview();
            updateSummary();
        }

        function updateCurrency() {
            certificateData.currency = currencySelect.value;
            updateSummary();
        }

        function updateLivePreview() {
            if (liveRecipientName) {
                liveRecipientName.textContent = certificateData.recipientName || 
                    '{% if language == "ru" %}–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è{% elif language == "kz" %}–ê–ª—É—à—ã –∞—Ç—ã{% else %}Recipient Name{% endif %}';
            }

            if (liveCertText) {
                liveCertText.textContent = certificateData.certificateText || 
                    '{% if language == "ru" %}–∑–∞ –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –∏ –∑–∞—â–∏—Ç—É –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã{% elif language == "kz" %}“ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É –∂”ô–Ω–µ “õ–æ—Ä—à–∞“ì–∞–Ω –æ—Ä—Ç–∞–Ω—ã “õ–æ—Ä“ì–∞—É–¥–∞“ì—ã “Ø–ª–µ—Å—ñ “Ø—à—ñ–Ω{% else %}for contributing to Kazakhstan\'s forest restoration and environmental protection{% endif %}';
            }

            if (liveSignature) {
                liveSignature.textContent = certificateData.signatureText;
            }

            if (liveTreeCount) {
                liveTreeCount.textContent = certificateData.treeCount;
            }

            if (treeLabel) {
                const language = '{{ language }}';
                if (language === 'ru') {
                    treeLabel.textContent = getRussianTreeLabel(certificateData.treeCount);
                } else if (language === 'kz') {
                    treeLabel.textContent = '–ê“ì–∞—à—Ç–∞—Ä —Å–∞–Ω—ã';
                } else {
                    treeLabel.textContent = 'Number of trees';
                }
            }
        }

        function updateSummary() {
            const trees = certificateData.treeCount;
            const totalKZT = trees * 5000;
            const rate = exchangeRates[certificateData.currency] || 1;
            const total = (totalKZT * rate).toFixed(2);

            if (summaryTrees) summaryTrees.textContent = trees;
            if (summaryTotal) summaryTotal.textContent = `${total} ${certificateData.currency}`;
        }

        function updateCertificateNumber() {
            if (certNumber) {
                const number = String(Date.now()).slice(-6);
                certNumber.textContent = number.padStart(6, '0');
            }
        }
        
        function handlePaymentSuccess(paymentResult) {
            console.log('Payment success handling:', paymentResult);
            
            if (paymentResult.userAuthenticated) {
                // IMMEDIATE redirect for authenticated users
                console.log('User authenticated, immediate redirect to profile');
                window.location.href = paymentResult.redirectUrl;
                return; // Stop further execution
            }
            
            if (paymentResult.showRegistration) {
                // Show registration modal immediately
                console.log('Showing registration modal');
                showFastRegistrationModal(paymentResult);
            } else {
                // Fallback to success screen
                showStep(5);
                updateSuccessScreen(paymentResult);
            }
        }

        function showFastRegistrationModal(paymentResult) {
            const modal = document.createElement('div');
            modal.id = 'fast-registration-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full animate-fadeIn">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">üéâ</div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω!</h2>
                        <p class="text-gray-600 text-sm">–ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ—Ñ–∏–ª—é</p>
                    </div>
                    
                    <form id="fast-register-form" class="space-y-3">
                        <input type="hidden" name="email" value="${paymentResult.customerEmail}">
                        <input type="hidden" name="name" value="${paymentResult.customerName || ''}">
                        <input type="hidden" name="phone" value="${paymentResult.customerPhone || ''}">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ü–∞—Ä–æ–ª—å *</label>
                            <input type="password" name="password" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                required minlength="8" placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤">
                        </div>
                        
                        <div class="error-message text-red-500 text-sm hidden" id="fast-error"></div>
                        
                        <div class="flex gap-2 pt-2">
                            <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition-colors text-sm">
                                –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                            </button>
                            <button type="button" onclick="closeFastRegistration()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition-colors text-sm">
                                –ü–æ–∑–∂–µ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            const form = modal.querySelector('#fast-register-form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                try {
                    submitBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
                    submitBtn.disabled = true;
                    
                    // Use the same endpoint as navbar registration
                    const response = await fetch('{% url "main_app:register" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCsrfToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Immediate redirect after successful registration
                        window.location.href = '{% url "main_app:profile" %}';
                    } else {
                        document.getElementById('fast-error').textContent = result.message;
                        document.getElementById('fast-error').classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                    
                } catch (error) {
                    console.error('Fast registration error:', error);
                    document.getElementById('fast-error').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                    document.getElementById('fast-error').classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        }

        function closeFastRegistration() {
            const modal = document.getElementById('fast-registration-modal');
            if (modal) {
                modal.remove();
            }
            showStep(5);
        }

        function skipRegistration() {
            // Remove modal and show success screen
            const modal = document.getElementById('post-payment-registration-modal');
            if (modal) {
                modal.remove();
            }
            showStep(5);
            
            // Update success screen for non-registered users
            const successMessage = document.querySelector('.success-screen h2');
            const successText = document.querySelector('.success-screen p');
            
            if (successMessage && successText) {
                successMessage.textContent = '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–∫–ª–∞–¥!';
                successText.innerHTML = '–í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email.<br><strong>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–∑–∂–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è!</strong>';
            }
        }

        // Update the existing updateSuccessScreen function
        function updateSuccessScreen(paymentResult) {
            const successMessage = document.querySelector('.success-screen h2');
            const successText = document.querySelector('.success-screen p');
            const downloadSection = document.querySelector('.download-section');
            
            // Clear existing buttons except download
            const existingButtons = downloadSection.querySelectorAll('button:not(.js-download-certificate)');
            existingButtons.forEach(btn => btn.remove());

            if (paymentResult.userAuthenticated) {
                successMessage.textContent = '–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!';
                successText.innerHTML = '–í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email.';
                
                // Add profile button
                const profileButton = document.createElement('button');
                profileButton.className = 'btn-primary js-go-to-profile';
                profileButton.innerHTML = 'üë§ –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å';
                profileButton.addEventListener('click', () => {
                    window.location.href = paymentResult.redirectUrl;
                });
                downloadSection.appendChild(profileButton);
                
            } else {
                successMessage.textContent = '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–∫–ª–∞–¥!';
                successText.innerHTML = '–í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email.<br><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é!</strong>';
                
                // Add register button
                const registerButton = document.createElement('button');
                registerButton.className = 'btn-primary js-go-to-register';
                registerButton.innerHTML = 'üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                registerButton.addEventListener('click', () => {
                    window.location.href = '{% url "main_app:register" %}';
                });
                downloadSection.appendChild(registerButton);
            }
        }

      

        async function handlePayment(e) {
            e.preventDefault();
            
            if (!validatePaymentData()) return;

            const submitBtn = e.target.querySelector('.btn-pay');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');

            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';

            try {
                // CRITICAL: Ensure phone is included in formData
                const formData = {
                    customerName: document.getElementById('customer-name').value,
                    customerEmail: document.getElementById('customer-email').value,
                    customerPhone: document.getElementById('customer-phone').value || '', // CRITICAL: Get phone value
                    recipientName: certificateData.recipientName,
                    certificateText: certificateData.certificateText,
                    signatureText: certificateData.signatureText,
                    treeCount: certificateData.treeCount,
                    templateId: selectedTemplate?.id,
                    selectedDesign: selectedDesign,
                    currency: certificateData.currency,
                    totalAmount: (certificateData.treeCount * 5000 * (exchangeRates[certificateData.currency] || 1)).toFixed(2)
                };

                console.log('Submitting payment with form data:', formData); // Debug log

                // Create the certificate order
                const createResponse = await fetch('/api/create-certificate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(formData)
                });

                const createResult = await createResponse.json();
                console.log('Create certificate result:', createResult);

                if (createResult.success) {
                    const orderId = createResult.orderId;
                    console.log('Order created with ID:', orderId);
                    
                    // Process payment with the order ID
                    await processPayment(formData, orderId);
                } else {
                    throw new Error(createResult.error || 'Failed to create certificate order');
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞: {% elif language == "kz" %}–¢”©–ª–µ–º–¥—ñ ”©“£–¥–µ—É “õ–∞—Ç–µ—Å—ñ: {% else %}Payment processing error: {% endif %}' + error.message);
                
                submitBtn.disabled = false;
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
            }
        }

        async function processPayment(formData, orderId) {
            if (typeof cp === 'undefined' || !cp.CloudPayments) {
                throw new Error('Payment system not loaded');
            }

            const widget = new cp.CloudPayments();
            const amount = parseFloat(formData.totalAmount);

            console.log('Starting payment with data:', formData); // Debug log

            return new Promise((resolve, reject) => {
                widget.pay('charge', {
                    publicId: 'test_api_00000000000000000000001',
                    description: `{% if language == "ru" %}–ü–æ—Å–∞–¥–∫–∞ ${formData.treeCount} –¥–µ—Ä–µ–≤—å–µ–≤ - –ù–∞—à –ª–µ—Å {% elif language == "kz" %}${formData.treeCount} –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑—É - –ù–∞—à –ª–µ—Å {% else %}Planting ${formData.treeCount} trees - –ù–∞—à –ª–µ—Å {% endif %}`,
                    amount: amount,
                    currency: formData.currency,
                    accountId: formData.customerEmail,
                    invoiceId: orderId,
                    skin: 'modern',
                    data: {
                        customerName: formData.customerName,
                        customerEmail: formData.customerEmail,
                        customerPhone: formData.customerPhone, // CRITICAL: Include phone in widget data
                        recipientName: formData.recipientName,
                        certificateText: formData.certificateText,
                        signatureText: formData.signatureText,
                        treeCount: formData.treeCount,
                        selectedDesign: formData.selectedDesign,
                        orderId: orderId
                    }
                }, {
                    onSuccess: async function(options) {
                        try {
                            console.log('Payment successful, options:', options);
                            
                            // CRITICAL: Construct complete payment data including phone
                            const paymentData = {
                                invoiceId: options.invoiceId || orderId,
                                accountId: formData.customerEmail,
                                transactionId: options.transactionId,
                                amount: formData.totalAmount,
                                currency: formData.currency,
                                customerName: formData.customerName,
                                customerEmail: formData.customerEmail,
                                customerPhone: formData.customerPhone, // CRITICAL: Include phone
                                recipientName: formData.recipientName,
                                certificateText: formData.certificateText,
                                signatureText: formData.signatureText,
                                treeCount: formData.treeCount,
                                selectedDesign: formData.selectedDesign,
                                orderId: orderId
                            };

                            console.log('Sending payment success data with phone:', paymentData);

                            const response = await fetch('/api/payment-success/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify(paymentData)
                            });

                            const paymentResult = await response.json();
                            console.log('Payment result:', paymentResult);
                            
                            if (paymentResult.success) {
                                handlePaymentSuccess(paymentResult);
                                resolve(paymentResult);
                            } else {
                                throw new Error(paymentResult.error || 'Payment confirmation failed');
                            }
                        } catch(error) {
                            console.error('Post-payment processing error:', error);
                            showStep(5);
                            alert('{% if language == "ru" %}–ü–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.{% elif language == "kz" %}–¢”©–ª–µ–º –∞—è“õ—Ç–∞–ª–¥—ã, –±—ñ—Ä–∞“õ ”©“£–¥–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã. “ö–æ–ª–¥–∞—É “õ—ã–∑–º–µ—Ç—ñ–Ω–µ —Ö–∞–±–∞—Ä–ª–∞—Å—ã“£—ã–∑.{% else %}Payment completed but there was an error processing. Contact support.{% endif %}');
                            reject(error);
                        }
                    },
                    onFail: function(reason, options) {
                        console.error('Payment failed:', reason, options);
                        alert('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞: {% elif language == "kz" %}–¢”©–ª–µ–º “õ–∞—Ç–µ—Å—ñ: {% else %}Payment error: {% endif %}' + reason);
                        
                        const submitBtn = document.querySelector('.btn-pay');
                        const btnText = submitBtn.querySelector('.btn-text');
                        const btnLoader = submitBtn.querySelector('.btn-loader');
                        
                        submitBtn.disabled = false;
                        btnText.style.display = 'inline-block';
                        btnLoader.style.display = 'none';
                        
                        reject(new Error(reason));
                    },
                    onComplete: function() {
                        console.log('Payment widget completed');
                    }
                });
            });
        }

        function showRegistrationPrompt(paymentResult) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full text-center animate-fadeIn">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">
                        –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–∫–ª–∞–¥!
                    </h2>
                    <p class="text-gray-600 mb-6">
                        –í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à–∏ –ø–æ—Å–∞–∂–µ–Ω–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è.
                    </p>
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-6">
                        <p class="text-sm text-gray-700">
                            <strong>–í–∞—à –≤–∫–ª–∞–¥:</strong><br>
                            üå≥ ${paymentResult.environmentalImpact?.co2_absorption_per_year || 0} –∫–≥ CO‚ÇÇ –≤ –≥–æ–¥<br>
                            üí® ${paymentResult.environmentalImpact?.oxygen_production_per_year || 0} –∫–≥ O‚ÇÇ –≤ –≥–æ–¥
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.location.href='${paymentResult.redirectUrl}'" 
                                class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 rounded-xl transition-all">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                        <button onclick="window.location.href='/'" 
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-xl transition-all">
                            –ù–∞ –≥–ª–∞–≤–Ω—É—é
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function downloadCertificate() {
            const certificate = document.getElementById('live-certificate');
            if (!certificate) {
                console.error('Certificate element not found');
                return;
            }

            try {
                const canvas = await html2canvas(certificate, {
                    scale: 2, // Higher resolution for sharpness
                    useCORS: true,
                    backgroundColor: null
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 0, (pdf.internal.pageSize.getHeight() - pdfHeight) / 2, pdfWidth, pdfHeight);
                pdf.save(`GreenMile_Certificate_${certNumber.textContent}.pdf`);
                console.log('Certificate downloaded successfully');
            } catch (error) {
                console.error('Download error:', error);
                alert('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == "kz" %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ{% else %}Error downloading certificate{% endif %}');
            }
        }

        function shareAchievement(platform) {
            const shareUrl = window.location.origin + '/certificate/' + certNumber.textContent;
            const shareText = '{% if language == "ru" %}–Ø –ø–æ—Å–∞–¥–∏–ª(–∞) –¥–µ—Ä–µ–≤—å—è —Å –ù–∞—à –ª–µ—Å ! –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç!{% elif language == "kz" %}–ú–µ–Ω –ù–∞—à –ª–µ—Å–∞—Ä“õ—ã–ª—ã –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑–¥—ã–º! –ú–µ–Ω—ñ“£ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã–º–¥—ã “õ–∞—Ä–∞“£—ã–∑!{% else %}I planted trees with –ù–∞—à –ª–µ—Å ! Check out my certificate!{% endif %}';
            let url = '';

            switch (platform) {
                case 'telegram':
                    url = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                    break;
                case 'whatsapp':
                    url = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
                    break;
                case 'facebook':
                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                    break;
                default:
                    console.warn('Unsupported platform:', platform);
                    return;
            }

            window.open(url, '_blank');
            console.log(`Sharing on ${platform}: ${shareUrl}`);
        }

        function getCsrfToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        }

          // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            .animate-fadeIn {
                animation: fadeIn 0.3s ease-out;
            }
            .hidden {
                display: none !important;
            }
        `;
        document.head.appendChild(style);
        // Initialize VanillaTilt for certificate preview
        VanillaTilt.init(document.getElementById('live-certificate'), {
            max: 15,
            speed: 400,
            glare: true,
            'max-glare': 0.3,
            scale: 1.02,
            perspective: 1000,
            easing: 'cubic-bezier(.03,.98,.52,.99)'
        });

        // Initialize the page
        init();
    });
</script>
{% endblock %}