{% extends "basement/base.html" %}
{% load static %}
{% load custom_filters %}
{% block header_section %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
{% endblock %}

{% block style %}
html {
    scroll-behavior: smooth;
}
section {
    scroll-margin-top: 80px;
}

/* Video Background Styling */
.video-background {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 0;
}

/* Profile Specific Styles */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: linear-gradient(135deg, #16a085, #2ecc71);
    color: white;
    padding: 2rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 10px 25px rgba(22, 160, 133, 0.3);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 1rem;
    opacity: 0.9;
}

.certificates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.certificate-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 2px solid #e5e7eb;
}

.certificate-card:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    border-color: #16a085;
}

.certificate-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.certificate-id {
    font-weight: 600;
    color: #16a085;
}

.certificate-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.certificate-details {
    margin-bottom: 1rem;
}

.certificate-trees {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a5f3f;
    margin-bottom: 0.5rem;
}

.certificate-date {
    color: #6b7280;
    font-size: 0.875rem;
}

.profile-section {
    background: white;
    border-radius: 16px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a5f3f;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #16a085;
    padding-bottom: 0.5rem;
}

.nav-link-white {
    color: #16a34a;
}

.nav-link-green {
    color: white;
}

.nav-link-blue {
    color: deepskyblue;
}

.logo-link {
    color: #16a34a;
}

/* Progress bars */
.progress-container {
    background: #e5e7eb;
    border-radius: 10px;
    height: 8px;
    margin: 1rem 0;
}

.progress-bar {
    height: 100%;
    border-radius: 10px;
    background: linear-gradient(135deg, #16a085, #2ecc71);
    transition: width 0.5s ease;
}

/* Environmental impact */
.impact-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
}

.impact-item {
    text-align: center;
    padding: 1rem;
    background: #f8fffe;
    border-radius: 8px;
    border: 1px solid #e0f2f1;
}

.impact-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #16a085;
    margin-bottom: 0.25rem;
}

.impact-label {
    font-size: 0.875rem;
    color: #6b7280;
}

/* Responsive */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .certificates-grid {
        grid-template-columns: 1fr;
    }
    
    .profile-section {
        padding: 1.5rem;
    }
    
    .section-title {
        font-size: 1.5rem;
    }
}

/* Confidential Data Styles */
.confidential-data-item {
    @apply flex justify-between items-center py-3 border-b border-gray-200 last:border-b-0;
}

.confidential-label {
    @apply text-gray-600;
}

.confidential-value {
    @apply font-mono text-gray-800;
}

/* Form Styles */
.account-form {
    @apply space-y-4;
}

.form-group {
    @apply mb-4;
}

.form-label {
    @apply block text-sm font-medium text-gray-700 mb-2;
}

.form-input {
    @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all;
}

.form-button {
    @apply w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-[1.02];
}

/* Notification Styles */
.notification {
    @apply fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-transform duration-300;
}

.notification-success {
    @apply bg-green-500 text-white;
}

.notification-error {
    @apply bg-red-500 text-white;
}

.notification-info {
    @apply bg-blue-500 text-white;
}

/* Security Badges */
.security-badge {
    @apply inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium;
}

.badge-secure {
    @apply bg-green-100 text-green-800;
}

.badge-warning {
    @apply bg-yellow-100 text-yellow-800;
}
{% endblock style %}

{% block content %}
<!-- Hero Section -->
<section class="relative min-h-[60vh] flex items-center justify-center overflow-hidden pt-20">
    <div class="absolute inset-0 z-0">
        <div class="absolute inset-0 bg-black/50 z-10"></div>
        <video class="video-background" autoplay loop muted playsinline>
            <source src="{% static 'videos/test.mp4' %}" type="video/mp4">
            {% if language == 'ru' %}–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.{% elif language == 'kz' %}–ë—Ä–∞—É–∑–µ—Ä—ñ“£—ñ–∑ –±–µ–π–Ω–µ–Ω—ñ “õ–æ–ª–¥–∞–º–∞–π–¥—ã.{% else %}Your browser does not support the video.{% endif %}
        </video>
    </div>

    <div class="relative z-20 text-center text-white max-w-4xl mx-auto px-4">
        <div class="w-32 h-32 mx-auto mb-6 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center border-4 border-white/30">
            <span class="text-4xl">üå±</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-bold mb-4 leading-tight">
            {% if language == 'ru' %}–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.first_name }}!{% elif language == 'kz' %}“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑, {{ user.first_name }}!{% else %}Welcome, {{ user.first_name }}!{% endif %}
        </h1>
        <p class="text-xl md:text-2xl mb-8 leading-relaxed opacity-90">
            {% if language == 'ru' %}–í–º–µ—Å—Ç–µ –º—ã —Å–æ–∑–¥–∞—ë–º –∑–µ–ª—ë–Ω–æ–µ –±—É–¥—É—â–µ–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞{% elif language == 'kz' %}–ë—ñ—Ä–≥–µ –±—ñ–∑ “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–Ω—ã“£ –∂–∞—Å—ã–ª –±–æ–ª–∞—à–∞“ì—ã–Ω –∂–∞—Å–∞–π–º—ã–∑{% else %}Together we're creating a green future for Kazakhstan{% endif %}
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="#stats" class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                {% if language == 'ru' %}–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% elif language == 'kz' %}–ú–µ–Ω—ñ“£ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–º{% else %}My Statistics{% endif %}
            </a>
            <a href="{% url 'main_app:certificate' %}" class="bg-white/20 hover:bg-white/30 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 backdrop-blur-sm border border-white/30">
                {% if language == 'ru' %}–°–æ–∑–¥–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∂–∞—Å–∞—É{% else %}Create Certificate{% endif %}
            </a>
        </div>
    </div>
</section>

<!-- Main Profile Content -->
<div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Quick Stats -->
    <section id="stats" class="profile-section">
        <h2 class="section-title">
            {% if language == 'ru' %}–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% elif language == 'kz' %}–ñ–∞–ª–ø—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% else %}Overall Statistics{% endif %}
        </h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ user_stats.total_trees|default:0 }}</div>
                <div class="stat-label">
                    {% if language == 'ru' %}–ü–æ—Å–∞–∂–µ–Ω–æ –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–û—Ç—ã—Ä“ì—ã–∑—ã–ª“ì–∞–Ω –∞“ì–∞—à—Ç–∞—Ä{% else %}Trees Planted{% endif %}
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ user_stats.total_certificates|default:0 }}</div>
                <div class="stat-label">
                    {% if language == 'ru' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤{% elif language == 'kz' %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç–∞—Ä{% else %}Certificates{% endif %}
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ user_stats.total_donations|default:0 }} ‚Ç∏</div>
                <div class="stat-label">
                    {% if language == 'ru' %}–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π{% elif language == 'kz' %}–ñ–∞–ª–ø—ã “õ–∞–π—ã—Ä—ã–º–¥—ã–ª—ã“õ —Å–æ–º–∞—Å—ã{% else %}Total Donations{% endif %}
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ user_stats.joined_days|default:0 }}</div>
                <div class="stat-label">
                    {% if language == 'ru' %}–î–Ω–µ–π —Å –Ω–∞–º–∏{% elif language == 'kz' %}–ë—ñ–∑–±–µ–Ω –±—ñ—Ä–≥–µ –∫“Ø–Ω{% else %}Days With Us{% endif %}
                </div>
            </div>
        </div>

        <!-- Progress towards goals -->
        <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                {% if language == 'ru' %}–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ –ø—Ä–æ–≥—Ä–µ—Å—ñ“£—ñ–∑{% else %}Your Progress{% endif %}
            </h3>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">
                            {% if language == 'ru' %}–¶–µ–ª—å: 100 –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–ú–∞“õ—Å–∞—Ç: 100 –∞“ì–∞—à{% else %}Goal: 100 Trees{% endif %}
                        </span>
                        <span class="text-green-600 font-semibold">
                            {{ user_stats.tree_progress_percentage|default:0 }}%
                        </span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: {{ user_stats.tree_progress_percentage|default:0 }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Environmental Impact -->
    <section class="profile-section">
        <h2 class="section-title">
            {% if language == 'ru' %}–í–∞—à–µ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ —ç–∫–æ–ª–æ–≥–∏—è–ª—ã“õ ”ô—Å–µ—Ä—ñ“£—ñ–∑{% else %}Your Environmental Impact{% endif %}
        </h2>
        
        <div class="impact-stats">
            <div class="impact-item">
                <div class="impact-value">{{ user_stats.co2_absorption|default:0 }} –∫–≥</div>
                <div class="impact-label">
                    {% if language == 'ru' %}CO¬≤ –ø–æ–≥–ª–æ—â–µ–Ω–æ –≤ –≥–æ–¥{% elif language == 'kz' %}–ñ—ã–ª—ã–Ω–∞ —Å—ñ“£—ñ—Ä—ñ–ª–≥–µ–Ω CO¬≤{% else %}CO¬≤ Absorbed per Year{% endif %}
                </div>
            </div>
            
            <div class="impact-item">
                <div class="impact-value">{{ user_stats.oxygen_production|default:0 }} –∫–≥</div>
                <div class="impact-label">
                    {% if language == 'ru' %}–ö–∏—Å–ª–æ—Ä–æ–¥–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ{% elif language == 'kz' %}”®–Ω–¥—ñ—Ä—ñ–ª–≥–µ–Ω –æ—Ç—Ç–µ–≥—ñ{% else %}Oxygen Produced{% endif %}
                </div>
            </div>
            
            <div class="impact-item">
                <div class="impact-value">{{ user_stats.air_quality_impact|default:0 }}</div>
                <div class="impact-label">
                    {% if language == 'ru' %}–õ—é–¥–µ–π –æ–±–µ—Å–ø–µ—á–µ–Ω–æ –≤–æ–∑–¥—É—Ö–æ–º{% elif language == 'kz' %}–ê—É–∞–º–µ–Ω “õ–∞–º—Ç—ã–ª“ì–∞–Ω –∞–¥–∞–º–¥–∞—Ä{% else %}People Provided with Air{% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- Certificates Section -->
    <section class="profile-section">
        <div class="flex justify-between items-center mb-6">
            <h2 class="section-title">
                {% if language == 'ru' %}–ú–æ–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã{% elif language == 'kz' %}–ú–µ–Ω—ñ“£ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç–∞—Ä—ã–º{% else %}My Certificates{% endif %}
            </h2>
            <a href="{% url 'main_app:certificate' %}" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105">
                {% if language == 'ru' %}+ –ù–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}+ –ñ–∞“£–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% else %}+ New Certificate{% endif %}
            </a>
        </div>

        {% if user_certificates %}
        <div class="certificates-grid">
            {% for certificate in user_certificates %}
            <div class="certificate-card">
                <div class="certificate-header">
                    <span class="certificate-id">#{{ certificate.certificate_id }}</span>
                    <span class="certificate-status status-{{ certificate.status }}">
                        {% if certificate.status == 'completed' %}
                            {% if language == 'ru' %}–ó–∞–≤–µ—Ä—à–µ–Ω–æ{% elif language == 'kz' %}–ê—è“õ—Ç–∞–ª–¥—ã{% else %}Completed{% endif %}
                        {% else %}
                            {% if language == 'ru' %}–í –æ–±—Ä–∞–±–æ—Ç–∫–µ{% elif language == 'kz' %}”®“£–¥–µ–ª—É–¥–µ{% else %}Processing{% endif %}
                        {% endif %}
                    </span>
                </div>
                
                <div class="certificate-details">
                    <div class="certificate-trees">
                        üå≥ {{ certificate.tree_count }} 
                        {% if language == 'ru' %}
                            {% if certificate.tree_count == 1 %}–¥–µ—Ä–µ–≤–æ{% elif certificate.tree_count < 5 %}–¥–µ—Ä–µ–≤–∞{% else %}–¥–µ—Ä–µ–≤—å–µ–≤{% endif %}
                        {% elif language == 'kz' %}
                            –∞“ì–∞—à
                        {% else %}
                            trees
                        {% endif %}
                    </div>
                    <div class="certificate-date">
                        {{ certificate.created_at|date:"d.m.Y" }}
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <strong>{% if language == 'ru' %}–ü–æ–ª—É—á–∞—Ç–µ–ª—å:{% elif language == 'kz' %}–ê–ª—É—à—ã:{% else %}Recipient:{% endif %}</strong> {{ certificate.recipient_name }}
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>{% if language == 'ru' %}–î–∏–∑–∞–π–Ω:{% elif language == 'kz' %}–î–∏–∑–∞–π–Ω:{% else %}Design:{% endif %}</strong> 
                        {% if certificate.design == 'professional' %}
                            {% if language == 'ru' %}–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π{% elif language == 'kz' %}–ö”ô—Å—ñ–±–∏{% else %}Professional{% endif %}
                        {% elif certificate.design == 'modern' %}
                            {% if language == 'ru' %}–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π{% elif language == 'kz' %}–ó–∞–º–∞–Ω–∞—É–∏{% else %}Modern{% endif %}
                        {% else %}
                            {% if language == 'ru' %}–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π{% elif language == 'kz' %}–°”ô–Ω–¥—ñ{% else %}Elegant{% endif %}
                        {% endif %}
                    </div>
                    <div class="text-sm text-green-600 font-semibold mt-1">
                        {{ certificate.total_amount }} {{ certificate.currency }}
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg transition-colors text-sm font-medium js-download-certificate" 
                            data-certificate-id="{{ certificate.certificate_id }}">
                        {% if language == 'ru' %}–°–∫–∞—á–∞—Ç—å{% elif language == 'kz' %}–ñ“Ø–∫—Ç–µ–ø –∞–ª—É{% else %}Download{% endif %}
                    </button>
                    <button class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors text-sm font-medium js-share-certificate"
                            data-certificate-id="{{ certificate.certificate_id }}">
                        {% if language == 'ru' %}–ü–æ–¥–µ–ª–∏—Ç—å—Å—è{% elif language == 'kz' %}–ë”©–ª—ñ—Å—É{% else %}Share{% endif %}
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üå±</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">
                {% if language == 'ru' %}–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤{% elif language == 'kz' %}–°—ñ–∑–¥–µ ”ô–ª—ñ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∂–æ“õ{% else %}You don't have any certificates yet{% endif %}
            </h3>
            <p class="text-gray-500 mb-6">
                {% if language == 'ru' %}–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ—Å–∞–¥–∫–∏ –¥–µ—Ä–µ–≤—å–µ–≤{% elif language == 'kz' %}–ê–ª“ì–∞—à“õ—ã –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã“£—ã–∑–¥—ã –∂–∞—Å–∞“£—ã–∑{% else %}Create your first tree planting certificate{% endif %}
            </p>
            <a href="{% url 'main_app:certificate' %}" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 inline-block">
                {% if language == 'ru' %}–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç{% elif language == 'kz' %}–ê–ª“ì–∞—à“õ—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –∂–∞—Å–∞—É{% else %}Create First Certificate{% endif %}
            </a>
        </div>
        {% endif %}
    </section>

    <!-- Recent Activity -->
    <section class="profile-section">
        <h2 class="section-title">
            {% if language == 'ru' %}–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å{% elif language == 'kz' %}–°–æ“£“ì—ã –±–µ–ª—Å–µ–Ω–¥—ñ–ª—ñ–∫{% else %}Recent Activity{% endif %}
        </h2>
        
        <div class="space-y-4">
            {% for activity in recent_activities %}
            <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                    {% if activity.type == 'certificate' %}üìÑ{% elif activity.type == 'donation' %}üíö{% else %}üå±{% endif %}
                </div>
                <div class="flex-1">
                    <p class="font-medium text-gray-800">{{ activity.description }}</p>
                    <p class="text-sm text-gray-500">{{ activity.date|timesince }} 
                        {% if language == 'ru' %}–Ω–∞–∑–∞–¥{% elif language == 'kz' %}–±“±—Ä—ã–Ω{% else %}ago{% endif %}
                    </p>
                </div>
                <div class="text-green-600 font-semibold">
                    {{ activity.amount }}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-500">
                {% if language == 'ru' %}–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞{% elif language == 'kz' %}–ë–µ–ª—Å–µ–Ω–¥—ñ–ª—ñ–∫ —Ç–∞–±—ã–ª–º–∞–¥—ã{% else %}No activity found{% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Account Actions -->
    <section class="profile-section">
        <h2 class="section-title">
            {% if language == 'ru' %}–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å{% elif language == 'kz' %}“ö“±–ø–∏—è –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂”ô–Ω–µ “õ–∞—É—ñ–ø—Å—ñ–∑–¥—ñ–∫{% else %}Confidential Data & Security{% endif %}
        </h2>
        
        <div class="space-y-6">
            <!-- Confidential Data Display -->
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-green-600">üîí</span>
                    {% if language == 'ru' %}–í–∞—à–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ{% elif language == 'kz' %}–°—ñ–∑–¥—ñ“£ “õ“±–ø–∏—è –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ“£—ñ–∑{% else %}Your Confidential Data{% endif %}
                </h3>
                
                <div id="confidential-data" class="space-y-3">
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <span class="text-gray-600">{% if language == 'ru' %}Email:{% elif language == 'kz' %}Email:{% else %}Email:{% endif %}</span>
                        <span id="user-email" class="font-mono text-gray-800">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <span class="text-gray-600">{% if language == 'ru' %}–¢–µ–ª–µ—Ñ–æ–Ω:{% elif language == 'kz' %}–¢–µ–ª–µ—Ñ–æ–Ω:{% else %}Phone:{% endif %}</span>
                        <span id="user-phone" class="font-mono text-gray-800">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <span class="text-gray-600">{% if language == 'ru' %}–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:{% elif language == 'kz' %}–¢—ñ—Ä–∫–µ—É –∫“Ø–Ω—ñ:{% else %}Registration Date:{% endif %}</span>
                        <span id="joined-date" class="text-gray-800">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div class="flex justify-between items-center py-3">
                        <span class="text-gray-600">{% if language == 'ru' %}–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:{% elif language == 'kz' %}–°–æ“£“ì—ã –∫—ñ—Ä—É:{% else %}Last Login:{% endif %}</span>
                        <span id="last-login" class="text-gray-800">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
                
                <button onclick="revealConfidentialData()" 
                        class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-colors font-medium">
                    {% if language == 'ru' %}–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ{% elif language == 'kz' %}–¢–æ–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∫”©—Ä—Å–µ—Ç—É{% else %}Show Full Data{% endif %}
                </button>
            </div>

            <!-- Password Change Card -->
            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-green-600">üîë</span>
                    {% if language == 'ru' %}–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è{% elif language == 'kz' %}“ö“±–ø–∏—è —Å”©–∑–¥—ñ ”©–∑–≥–µ—Ä—Ç—É{% else %}Change Password{% endif %}
                </h3>
                
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if language == 'ru' %}–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å{% elif language == 'kz' %}–ê“ì—ã–º–¥–∞“ì—ã “õ“±–ø–∏—è —Å”©–∑{% else %}Current Password{% endif %}
                        </label>
                        <input type="password" name="current_password" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if language == 'ru' %}–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å{% elif language == 'kz' %}–ñ–∞“£–∞ “õ“±–ø–∏—è —Å”©–∑{% else %}New Password{% endif %}
                        </label>
                        <input type="password" name="new_password" required minlength="8"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                            placeholder="{% if language == 'ru' %}–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤{% elif language == 'kz' %}–ö–µ–º—ñ–Ω–¥–µ 8 —Ç–∞“£–±–∞{% else %}Minimum 8 characters{% endif %}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if language == 'ru' %}–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å{% elif language == 'kz' %}–ñ–∞“£–∞ “õ“±–ø–∏—è —Å”©–∑–¥—ñ —Ä–∞—Å—Ç–∞“£—ã–∑{% else %}Confirm New Password{% endif %}
                        </label>
                        <input type="password" name="confirm_password" required minlength="8"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-[1.02]">
                        {% if language == 'ru' %}–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å{% elif language == 'kz' %}“ö“±–ø–∏—è —Å”©–∑–¥—ñ ”©–∑–≥–µ—Ä—Ç—É{% else %}Change Password{% endif %}
                    </button>
                </form>
                
                <div id="password-message" class="mt-3 hidden"></div>
            </div>

            <!-- Email Change Card -->
            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-green-600">üìß</span>
                    {% if language == 'ru' %}–°–º–µ–Ω–∞ email{% elif language == 'kz' %}Email ”©–∑–≥–µ—Ä—Ç—É{% else %}Change Email{% endif %}
                </h3>
                
                <form id="change-email-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if language == 'ru' %}–ù–æ–≤—ã–π email{% elif language == 'kz' %}–ñ–∞“£–∞ email{% else %}New Email{% endif %}
                        </label>
                        <input type="email" name="new_email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                            placeholder="{% if language == 'ru' %}example@domain.com{% elif language == 'kz' %}example@domain.com{% else %}example@domain.com{% endif %}">
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-[1.02]">
                        {% if language == 'ru' %}–°–º–µ–Ω–∏—Ç—å email{% elif language == 'kz' %}Email ”©–∑–≥–µ—Ä—Ç—É{% else %}Change Email{% endif %}
                    </button>
                </form>
                
                <div id="email-message" class="mt-3 hidden"></div>
            </div>

            <!-- Account Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                <a href="{% url 'main_app:logout' %}" class="p-6 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition-colors text-center group">
                    <div class="text-red-600 text-2xl mb-2 group-hover:scale-110 transition-transform">üö™</div>
                    <h3 class="font-semibold text-red-700 mb-1">
                        {% if language == 'ru' %}–í—ã–π—Ç–∏{% elif language == 'kz' %}–®—ã“ì—É{% else %}Log Out{% endif %}
                    </h3>
                    <p class="text-red-600 text-sm">
                        {% if language == 'ru' %}–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–µ–∞–Ω—Å{% elif language == 'kz' %}–ê“ì—ã–º–¥–∞“ì—ã —Å–µ–∞–Ω—Å—Ç—ã –∞—è“õ—Ç–∞—É{% else %}End current session{% endif %}
                    </p>
                </a>
                
                <button onclick="downloadUserData()" class="p-6 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg transition-colors text-center group cursor-pointer">
                    <div class="text-purple-600 text-2xl mb-2 group-hover:scale-110 transition-transform">üì•</div>
                    <h3 class="font-semibold text-purple-700 mb-1">
                        {% if language == 'ru' %}–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö{% elif language == 'kz' %}–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞—É{% else %}Export Data{% endif %}
                    </h3>
                    <p class="text-purple-600 text-sm">
                        {% if language == 'ru' %}–°–∫–∞—á–∞—Ç—å –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ{% elif language == 'kz' %}–ë–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É{% else %}Download all your data{% endif %}
                    </p>
                </button>
            </div>
        </div>
    </section>
</div>

<script>
    // ‚úÖ FIXED: Move functions to global scope
    async function downloadCertificateFromProfile(certificateId, event) {
        let button = event.target;
        const originalText = button.textContent;
        
        try {
            // Show loading state
            button.textContent = '‚è≥ {% if language == "ru" %}–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...{% elif language == "kz" %}–ì–µ–Ω–µ—Ä–∞—Ü–∏—è–ª–∞—É...{% else %}Generating...{% endif %}';
            button.disabled = true;

            console.log('Starting download for certificate:', certificateId);

            // ‚úÖ FIXED: Get certificate data directly from the card with proper selectors
            const certificateCard = button.closest('.certificate-card');
            
            // Extract recipient name - FIXED selector
            const recipientElement = certificateCard.querySelector('.text-sm.text-gray-600');
            let recipientName = '–ü–æ–ª—É—á–∞—Ç–µ–ª—å';
            if (recipientElement) {
                const recipientText = recipientElement.textContent;
                recipientName = recipientText.replace('–ü–æ–ª—É—á–∞—Ç–µ–ª—å:', '').replace('–ê–ª—É—à—ã:', '').replace('Recipient:', '').trim() || '–ü–æ–ª—É—á–∞—Ç–µ–ª—å';
            }

            // Extract tree count - FIXED selector
            const treeCountElement = certificateCard.querySelector('.certificate-trees');
            let treeCount = 10;
            if (treeCountElement) {
                const treeText = treeCountElement.textContent;
                const treeMatch = treeText.match(/\d+/);
                treeCount = treeMatch ? parseInt(treeMatch[0]) : 10;
            }

            // Extract design
            const designElement = certificateCard.querySelector('.text-sm.text-gray-600:nth-child(3)');
            let design = 'professional';
            if (designElement) {
                const designText = designElement.textContent;
                if (designText.includes('–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π') || designText.includes('–ö”ô—Å—ñ–±–∏') || designText.includes('Professional')) {
                    design = 'professional';
                } else if (designText.includes('–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π') || designText.includes('–ó–∞–º–∞–Ω–∞—É–∏') || designText.includes('Modern')) {
                    design = 'modern';
                } else if (designText.includes('–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π') || designText.includes('–°”ô–Ω–¥—ñ') || designText.includes('Elegant')) {
                    design = 'elegant';
                }
            }

            // Create certificate data
            const certificateData = {
                certificateId: certificateId,
                recipientName: recipientName,
                treeCount: treeCount,
                design: design,
                certificateText: '{% if language == "ru" %}–±—ã–ª–æ –ø–æ—Å–∞–∂–µ–Ω–æ –≤ –í–∞—à–µ –∏–º—è, –≤–Ω–æ—Å—è –≤–∫–ª–∞–¥ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.{% elif language == "kz" %}–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑–¥–∞–Ω “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –æ—Ä–º–∞–Ω–¥–∞—Ä—ã–Ω “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–≥–µ “õ–æ—Å“õ–∞–Ω “Ø–ª–µ—Å—ñ“£—ñ–∑ “Ø—à—ñ–Ω.{% else %}has been planted in your name, supporting forest restoration in Kazakhstan.{% endif %}',
                signatureText: '{% if language == "ru" %}–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ö–æ–º–∞–Ω–¥–∞ –ù–∞—à –ª–µ—Å{% elif language == "kz" %}“ö“±—Ä–º–µ—Ç–ø–µ–Ω, –ù–∞—à –ª–µ—Å –∫–æ–º–∞–Ω–¥–∞—Å—ã{% else %}With respect, –ù–∞—à –ª–µ—Å Team{% endif %}'
            };

            console.log('Certificate data:', certificateData);
            
            // Generate and download
            await generateAndDownloadCertificate(certificateData);
            
        } catch (error) {
            console.error('Download error:', error);
            alert('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == "kz" %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ{% else %}Error downloading certificate{% endif %}');
        } finally {
            // Restore button state
            if (button) {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
    }

    // ‚úÖ FIXED: Certificate generation function
    async function generateAndDownloadCertificate(certificateData) {
        console.log('Generating certificate with data:', certificateData);
        
        return new Promise(async (resolve, reject) => {
            try {
                // Create a temporary div for certificate generation
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 794px;
                    height: 1123px;
                    background: white;
                    padding: 40px;
                    z-index: 10000;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                    font-family: 'Inter', sans-serif;
                `;

                // ‚úÖ FIXED: Use static background image without JavaScript template syntax
                const backgroundImage = getDesignBackground(certificateData.design);
                
                tempDiv.innerHTML = `
                    <div style="height: 100%; border: 3px solid #16a085; border-radius: 10px; padding: 30px; background: white; background-image: url('${backgroundImage}'); background-size: cover; background-position: center;">
                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 2rem;">
                            <div class="cert-border" style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                                <div class="cert-header-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <div class="cert-logo-section" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="logo-icon" style="font-size: 1.8rem;">üå±</div>
                                        <div class="org-name" style="font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; color: #16a085;">–ù–∞—à –ª–µ—Å</div>
                                    </div>
                                    <div class="cert-number" style="font-size: 0.875rem; color: #6b7280; padding: 0.25rem 0.75rem; border-radius: 20px;">
                                        ‚Ññ ${certificateData.certificateId}
                                    </div>
                                </div>
                                
                                <div class="cert-main-section" style="text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                    <h1 class="cert-main-title" style="font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: #1a5f3f; margin-bottom: 0.5rem; letter-spacing: 2px;">
                                        {% if language == 'ru' %}–°–ï–†–¢–ò–§–ò–ö–ê–¢{% elif language == 'kz' %}–°–ï–†–¢–ò–§–ò–ö–ê–¢{% else %}CERTIFICATE{% endif %}
                                    </h1>
                                    
                                    <div class="cert-subtitle" style="font-size: 1rem; color: #6b7280; margin-bottom: 1.5rem; font-style: italic;">
                                        {% if language == 'ru' %}–ó–∞ –≤–∫–ª–∞–¥ –≤ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –±—É–¥—É—â–µ–µ{% elif language == 'kz' %}–ñ–∞—Å—ã–ª –±–æ–ª–∞—à–∞“õ“õ–∞ “Ø–ª–µ—Å “õ–æ—Å“õ–∞–Ω—ã “Ø—à—ñ–Ω{% else %}For a Contribution to a Greener Future{% endif %}
                                    </div>
                                    
                                    <div class="recipient-section" style="margin-bottom: 1.5rem;">
                                        <div class="recipient-label" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                                            {% if language == 'ru' %}–ù–∞–≥—Ä–∞–∂–¥–∞–µ—Ç—Å—è{% elif language == 'kz' %}–ú–∞—Ä–∞–ø–∞—Ç—Ç–∞–ª–∞–¥—ã{% else %}This certificate is proudly presented to{% endif %}
                                        </div>
                                        <div class="recipient-name" style="font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 600; color: #1a5f3f; border-bottom: 2px solid #16a085; padding-bottom: 0.25rem; display: inline-block; min-width: 200px;">
                                            ${certificateData.recipientName}
                                        </div>
                                    </div>
                                    
                                    <div class="achievement-section" style="margin-bottom: 2rem;">
                                        <div class="tree-info" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1rem; font-size: 1.5rem; color: #16a085; font-weight: 600; background: rgba(22,160,133,0.05); padding: 0.75rem 1.5rem; border-radius: 50px; box-shadow: 0 2px 10px rgba(22,160,133,0.1);">
                                            <span class="tree-count-display" style="font-size: 2rem; font-weight: 700;">${certificateData.treeCount}</span>
                                            <span class="tree-label">
                                                ${getRussianTreeLabel(certificateData.treeCount)}
                                            </span>
                                        </div>
                                        
                                        <div class="cert-description" style="font-size: 1rem; color: #4b5e5a; line-height: 1.5; max-width: 500px; margin: 0 auto; font-style: italic; padding: 1rem; border-left: 4px solid #16a085;">
                                            ${certificateData.certificateText}
                                        </div>
                                    </div>
                                    
                                    <div class="signature-section" style="margin-bottom: 1.5rem;">
                                        <div class="signature-line">
                                            <div class="signature-text" style="font-family: 'Playfair Display', serif; color: #16a085; font-style: italic; border-top: 2px dashed #16a085; padding-top: 0.5rem; text-align: right;">
                                                ${certificateData.signatureText}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="cert-footer" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; background: rgba(22,160,133,0.03);">
                                    <div class="website" style="font-weight: 600; color: #16a085;">greenmile.kz</div>
                                    <div class="impact-text" style="max-width: 200px; text-align: right; font-style: italic;">
                                        {% if language == 'ru' %}–í–º–µ—Å—Ç–µ –º—ã —Å–æ–∑–¥–∞—ë–º –∑–µ–ª—ë–Ω–æ–µ –±—É–¥—É—â–µ–µ.{% elif language == 'kz' %}–ë—ñ—Ä–≥–µ –±—ñ–∑ –∂–∞—Å—ã–ª –±–æ–ª–∞—à–∞“õ—Ç—ã “õ“±—Ä–∞–º—ã–∑.{% else %}Together, we are growing a greener tomorrow.{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add to document
                document.body.appendChild(tempDiv);

                // Wait a bit for rendering
                await new Promise(resolve => setTimeout(resolve, 100));

                console.log('Starting html2canvas conversion...');

                // Generate canvas
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: 794,
                    height: 1123
                });

                console.log('html2canvas completed');

                // Generate PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgData = canvas.toDataURL('image/png', 1.0);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                const filename = `–ù–∞—à_–ª–µ—Å_–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç_${certificateData.certificateId}.pdf`;
                pdf.save(filename);

                console.log('PDF download completed:', filename);

                // Clean up
                document.body.removeChild(tempDiv);
                resolve();

            } catch (error) {
                console.error('Certificate generation error:', error);
                reject(error);
            }
        });
    }

    // ‚úÖ FIXED: Get design background image
    function getDesignBackground(design) {
        const backgrounds = {
            'professional': '{% static "img/default-professional.jpg" %}',
            'modern': '{% static "img/default-modern.jpg" %}',
            'elegant': '{% static "img/default-elegant.jpg" %}'
        };
        return backgrounds[design] || backgrounds['professional'];
    }

    // ‚úÖ FIXED: Russian tree label function
    function getRussianTreeLabel(count) {
        if (!count || count < 1) return '–¥–µ—Ä–µ–≤—å–µ–≤';
        
        const lastDigit = count % 10;
        const lastTwoDigits = count % 100;
        
        if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
            return '–¥–µ—Ä–µ–≤—å–µ–≤';
        }
        if (lastDigit === 1) {
            return '–¥–µ—Ä–µ–≤–æ';
        }
        if (lastDigit >= 2 && lastDigit <= 4) {
            return '–¥–µ—Ä–µ–≤–∞';
        }
        return '–¥–µ—Ä–µ–≤—å–µ–≤';
    }

    // ‚úÖ FIXED: Share functionality
    function shareCertificateFromProfile(certificateId) {
        const shareUrl = `${window.location.origin}/certificate/success/${certificateId}`;
        const shareText = '{% if language == "ru" %}–Ø –ø–æ—Å–∞–¥–∏–ª(–∞) –¥–µ—Ä–µ–≤—å—è —Å –ù–∞—à –ª–µ—Å! –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç!{% elif language == "kz" %}–ú–µ–Ω –ù–∞—à –ª–µ—Å –∞—Ä“õ—ã–ª—ã –∞“ì–∞—à –æ—Ç—ã—Ä“ì—ã–∑–¥—ã–º! –ú–µ–Ω—ñ“£ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã–º–¥—ã “õ–∞—Ä–∞“£—ã–∑!{% else %}I planted trees with –ù–∞—à –ª–µ—Å! Check out my certificate!{% endif %}';
        
        if (navigator.share) {
            navigator.share({
                title: '–ù–∞—à –ª–µ—Å Certificate',
                text: shareText,
                url: shareUrl
            }).catch(err => {
                console.log('Share cancelled:', err);
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(`${shareText} ${shareUrl}`).then(() => {
                alert('{% if language == "ru" %}–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!{% elif language == "kz" %}–°—ñ–ª—Ç–µ–º–µ –∞–ª–º–∞—Å—É –±—É—Ñ–µ—Ä—ñ–Ω–µ –∫”©—à—ñ—Ä—ñ–ª–¥—ñ!{% else %}Link copied to clipboard!{% endif %}');
            }).catch(err => {
                console.error('Clipboard error:', err);
                // Fallback: show URL
                alert(`{% if language == "ru" %}–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: {% elif language == "kz" %}–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å—ñ–ª—Ç–µ–º–µ—Å—ñ: {% else %}Certificate link: {% endif %}${shareUrl}`);
            });
        }
    }

    // ‚úÖ FIXED: Setup function
    function setupDownloadButtons() {
        const downloadButtons = document.querySelectorAll('.js-download-certificate');
        console.log(`Found ${downloadButtons.length} download buttons`);
        
        if (downloadButtons.length === 0) {
            console.warn('No download buttons found with class .js-download-certificate');
            return;
        }
        
        downloadButtons.forEach((button, index) => {
            const certificateId = button.dataset.certificateId;
            console.log(`Button ${index + 1}:`, {
                certificateId: certificateId,
                text: button.textContent,
                parent: button.closest('.certificate-card')
            });
            
            // Remove any existing listeners to avoid duplicates
            button.replaceWith(button.cloneNode(true));
        });
        
        // Re-query after cloning
        const freshButtons = document.querySelectorAll('.js-download-certificate');
        
        freshButtons.forEach(button => {
            button.addEventListener('click', async function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const certificateId = this.dataset.certificateId;
                console.log('=== DOWNLOAD BUTTON CLICKED ===');
                console.log('Certificate ID:', certificateId);
                console.log('Button:', this);
                
                if (!certificateId) {
                    console.error('NO CERTIFICATE ID FOUND IN DATASET!');
                    console.log('Full dataset:', this.dataset);
                    alert('{% if language == "ru" %}–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞{% elif language == "kz" %}“ö–∞—Ç–µ: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã{% else %}Error: Could not find certificate data{% endif %}');
                    return;
                }
                
                try {
                    await downloadCertificateFromProfile(certificateId, event);
                } catch (error) {
                    console.error('Download error:', error);
                    alert('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏: {% elif language == "kz" %}–ñ“Ø–∫—Ç–µ—É –∫–µ–∑—ñ–Ω–¥–µ–≥—ñ “õ–∞—Ç–µ: {% else %}Download error: {% endif %}' + error.message);
                }
            });
        });

        // Setup share buttons
        const shareButtons = document.querySelectorAll('.js-share-certificate');
        shareButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const certificateId = this.dataset.certificateId;
                console.log('Share button clicked for certificate:', certificateId);
                shareCertificateFromProfile(certificateId);
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, setting up download buttons...');

        setupDownloadButtons();
        
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Animate progress bars on scroll
        const observerOptions = {
            threshold: 0.5,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const progressBar = entry.target.querySelector('.progress-bar');
                    if (progressBar) {
                        const width = progressBar.style.width;
                        progressBar.style.width = '0%';
                        setTimeout(() => {
                            progressBar.style.width = width;
                        }, 100);
                    }
                }
            });
        }, observerOptions);

        document.querySelectorAll('.progress-container').forEach(container => {
            observer.observe(container);
        });
    });

    // CSRF token function
    function getCsrfToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [key, value] = cookie.trim().split('=');
            if (key === name) {
                return decodeURIComponent(value);
            }
        }
        return '';
    }

    // Confidential Data Management
    async function loadConfidentialData() {
        try {
            const response = await fetch('{% url "main_app:confidential_data" %}');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('user-email').textContent = data.email;
                document.getElementById('user-phone').textContent = data.phone;
                document.getElementById('joined-date').textContent = data.joined_date;
                document.getElementById('last-login').textContent = data.last_login;
                
                // Store full data for reveal
                document.getElementById('confidential-data').dataset.fullEmail = data.full_email;
                document.getElementById('confidential-data').dataset.fullPhone = data.full_phone;
            }
        } catch (error) {
            console.error('Error loading confidential data:', error);
        }
    }

    function revealConfidentialData() {
        const container = document.getElementById('confidential-data');
        const fullEmail = container.dataset.fullEmail;
        const fullPhone = container.dataset.fullPhone;
        
        if (fullEmail && fullPhone) {
            document.getElementById('user-email').textContent = fullEmail;
            document.getElementById('user-phone').textContent = fullPhone || '–ù–µ —É–∫–∞–∑–∞–Ω';
            
            // Show notification
            showNotification('{% if language == "ru" %}–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω—ã{% elif language == "kz" %}–¢–æ–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä –∫”©—Ä—Å–µ—Ç—ñ–ª–¥—ñ{% else %}Full data revealed{% endif %}', 'success');
        }
    }

    // Password Change
    document.getElementById('change-password-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            current_password: formData.get('current_password'),
            new_password: formData.get('new_password'),
            confirm_password: formData.get('confirm_password')
        };
        
        const button = this.querySelector('button[type="submit"]');
        const originalText = button.textContent;
        
        try {
            button.textContent = '{% if language == "ru" %}–°–º–µ–Ω–∞...{% elif language == "kz" %}”®–∑–≥–µ—Ä—Ç—É...{% else %}Changing...{% endif %}';
            button.disabled = true;
            
            const response = await fetch('{% url "main_app:change_password" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            const messageDiv = document.getElementById('password-message');
            messageDiv.className = `mt-3 p-3 rounded-lg ${result.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageDiv.textContent = result.message;
            messageDiv.classList.remove('hidden');
            
            if (result.success) {
                this.reset();
                setTimeout(() => messageDiv.classList.add('hidden'), 5000);
            }
            
        } catch (error) {
            console.error('Password change error:', error);
            showNotification('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è{% elif language == "kz" %}“ö“±–ø–∏—è —Å”©–∑–¥—ñ ”©–∑–≥–µ—Ä—Ç—É –∫–µ–∑—ñ–Ω–¥–µ–≥—ñ “õ–∞—Ç–µ{% else %}Error changing password{% endif %}', 'error');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    });

    // Email Change
    document.getElementById('change-email-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            new_email: formData.get('new_email')
        };
        
        const button = this.querySelector('button[type="submit"]');
        const originalText = button.textContent;
        
        try {
            button.textContent = '{% if language == "ru" %}–ü—Ä–æ–≤–µ—Ä–∫–∞...{% elif language == "kz" %}–¢–µ–∫—Å–µ—Ä—É...{% else %}Checking...{% endif %}';
            button.disabled = true;
            
            const response = await fetch('{% url "main_app:change_email" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            const messageDiv = document.getElementById('email-message');
            messageDiv.className = `mt-3 p-3 rounded-lg ${result.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageDiv.textContent = result.message;
            messageDiv.classList.remove('hidden');
            
            if (result.success) {
                this.reset();
                // Reload confidential data to show new email
                loadConfidentialData();
                setTimeout(() => messageDiv.classList.add('hidden'), 5000);
            }
            
        } catch (error) {
            console.error('Email change error:', error);
            showNotification('{% if language == "ru" %}–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ email{% elif language == "kz" %}Email ”©–∑–≥–µ—Ä—Ç—É –∫–µ–∑—ñ–Ω–¥–µ–≥—ñ “õ–∞—Ç–µ{% else %}Error changing email{% endif %}', 'error');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    });

    // Utility function for notifications
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-transform duration-300 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 5 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 5000);
    }

    // Download user data (example implementation)
    function downloadUserData() {
        showNotification('{% if language == "ru" %}–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞{% elif language == "kz" %}–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã –∂–∞“õ—ã–Ω–¥–∞ “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –±–æ–ª–∞–¥—ã{% else %}Data export feature coming soon{% endif %}', 'info');
    }

    // Load confidential data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadConfidentialData();
        
        // Existing setup code...
        setupDownloadButtons();
        
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Animate progress bars on scroll
        const observerOptions = {
            threshold: 0.5,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const progressBar = entry.target.querySelector('.progress-bar');
                    if (progressBar) {
                        const width = progressBar.style.width;
                        progressBar.style.width = '0%';
                        setTimeout(() => {
                            progressBar.style.width = width;
                        }, 100);
                    }
                }
            });
        }, observerOptions);

        document.querySelectorAll('.progress-container').forEach(container => {
            observer.observe(container);
        });
    });

</script> 

{% endblock %}